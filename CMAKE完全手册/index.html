<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********  Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>CMAKE完全手册 | Just Note</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Just Note">
    <meta name="author" content="Fravel Wang">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Just Note" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Just Note</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2025-10-12T17:39:14.000Z" itemprop="datePublished">
          2025-10-13
      </time>
    
</span>
                <h1>CMAKE完全手册</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>配合CMake简明教程使用，细节更多, 日常小项目，简明手册的工程模板完全够用,这个教程末尾的模板就是更符合国际惯例一些</p>
<span id="more"></span>

<hr>
<h1 id="🧱-第-1-章-CMake-变量系统全解（脚本语法核心）"><a href="#🧱-第-1-章-CMake-变量系统全解（脚本语法核心）" class="headerlink" title="🧱 第 1 章 | CMake 变量系统全解（脚本语法核心）"></a>🧱 第 1 章 | CMake 变量系统全解（脚本语法核心）</h1><hr>
<h2 id="1-变量类型与定义规则"><a href="#1-变量类型与定义规则" class="headerlink" title="1. 变量类型与定义规则"></a>1. 变量类型与定义规则</h2><p>CMake 的脚本世界里，一切都是字符串变量（无显式数据类型）。<br>语法结构：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(&lt;变量名&gt; &lt;值&gt; [CACHE &lt;类型&gt; &lt;描述&gt; [FORCE]])</span><br></pre></td></tr></table></figure>

<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(MY_NAME <span class="string">&quot;Alice&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;name = $&#123;MY_NAME&#125;&quot;</span>)  <span class="comment"># 输出：name = Alice</span></span><br></pre></td></tr></table></figure>

<p><strong>说明：</strong>  </p>
<ul>
<li>变量区分大小写；  </li>
<li>默认作用域是当前文件；  </li>
<li>在函数 function 内是局部作用域；在 macro 则共享外层；  </li>
<li><code>$&#123;变量名&#125;</code> 取值，不能省 <code>$&#123;&#125;</code>。</li>
</ul>
<hr>
<h2 id="2-三类主要变量"><a href="#2-三类主要变量" class="headerlink" title="2. 三类主要变量"></a>2. 三类主要变量</h2><table>
<thead>
<tr>
<th>分类</th>
<th>定义方式</th>
<th>生命周期 &#x2F; 存储位置</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>普通变量</td>
<td><code>set(VAR val)</code></td>
<td>当前作用域</td>
<td><code>set(A 5)</code></td>
</tr>
<tr>
<td>缓存变量</td>
<td><code>set(VAR val CACHE TYPE DESC)</code></td>
<td>写入 CMakeCache.txt</td>
<td>构建配置选项</td>
</tr>
<tr>
<td>环境变量</td>
<td><code>set(ENV&#123;VAR&#125; val)</code></td>
<td>传递给外部命令环境</td>
<td><code>set(ENV&#123;PATH&#125; /opt/bin:$ENV&#123;PATH&#125;)</code></td>
</tr>
</tbody></table>
<p>🔹 <strong>环境变量示例：</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message</span>(<span class="string">&quot;before = $ENV&#123;PATH&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(ENV&#123;PATH&#125; <span class="string">&quot;/extra:$ENV&#123;PATH&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">execute_process</span>(<span class="keyword">COMMAND</span> env)  <span class="comment"># 生成过程中的环境可用</span></span><br></pre></td></tr></table></figure>

<p>🔹 <strong>缓存变量示例：</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(BUILD_VERBOSE <span class="keyword">ON</span> CACHE BOOL <span class="string">&quot;Show build details&quot;</span>)</span><br><span class="line"><span class="comment"># 命令行：cmake -DBUILD_VERBOSE=ON ..</span></span><br></pre></td></tr></table></figure>

<p>缓存变量可用于生成配置选项界面（ccmake &#x2F; CMake GUI），值持久化在当前 build 目录，除非加 FORCE 才会覆盖。</p>
<hr>
<h2 id="3-变量作用域示例"><a href="#3-变量作用域示例" class="headerlink" title="3. 变量作用域示例"></a>3. 变量作用域示例</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(V outer)</span><br><span class="line"><span class="keyword">function</span>(<span class="keyword">test</span>)</span><br><span class="line">  <span class="keyword">set</span>(V inner)</span><br><span class="line">  <span class="keyword">message</span>(<span class="string">&quot;in function: $&#123;V&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">endfunction</span>()</span><br><span class="line"><span class="keyword">test</span>()</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;outside: $&#123;V&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">in function: inner</span><br><span class="line">outside: outer</span><br></pre></td></tr></table></figure>

<p>function 内部不会修改外层；<br>若用 macro 定义，则作用域共享，会改动外层。  </p>
<hr>
<h2 id="4-列表与字符串操作"><a href="#4-列表与字符串操作" class="headerlink" title="4. 列表与字符串操作"></a>4. 列表与字符串操作</h2><h3 id="4-1-列表基础"><a href="#4-1-列表基础" class="headerlink" title="4.1 列表基础"></a>4.1 列表基础</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(MYLIST A B C)</span><br><span class="line"><span class="keyword">list</span>(APPEND MYLIST D)</span><br><span class="line"><span class="keyword">foreach</span>(item IN LISTS MYLIST)</span><br><span class="line">  <span class="keyword">message</span>(<span class="string">&quot;item=$&#123;item&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">endforeach</span>()</span><br></pre></td></tr></table></figure>

<h3 id="4-2-常用-list-子命令"><a href="#4-2-常用-list-子命令" class="headerlink" title="4.2 常用 list() 子命令"></a>4.2 常用 list() 子命令</h3><table>
<thead>
<tr>
<th>子命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>APPEND</td>
<td>追加</td>
</tr>
<tr>
<td>LENGTH</td>
<td>获取长度</td>
</tr>
<tr>
<td>GET i</td>
<td>取元素</td>
</tr>
<tr>
<td>REMOVE_ITEM</td>
<td>删除匹配项</td>
</tr>
<tr>
<td>JOIN</td>
<td>合并为字符串</td>
</tr>
</tbody></table>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">list</span>(JOIN MYLIST <span class="string">&quot;,&quot;</span> JOINED)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;$&#123;JOINED&#125;&quot;</span>)  <span class="comment"># → A,B,C,D</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-3-字符串处理"><a href="#4-3-字符串处理" class="headerlink" title="4.3 字符串处理"></a>4.3 字符串处理</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span>(TOUPPER <span class="string">&quot;abc&quot;</span> OUT)     <span class="comment"># 变大写</span></span><br><span class="line"><span class="keyword">string</span>(SUBSTRING <span class="string">&quot;abcdef&quot;</span> <span class="number">0</span> <span class="number">3</span> FIRST)</span><br><span class="line"><span class="keyword">string</span>(REPLACE <span class="string">&quot;a&quot;</span> <span class="string">&quot;x&quot;</span> CHANGED <span class="string">&quot;$&#123;VAR&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">string</span>(FIND <span class="string">&quot;$&#123;TEXT&#125;&quot;</span> <span class="string">&quot;key&quot;</span> POS)</span><br></pre></td></tr></table></figure>

<p>📘 CMake 字符串操作统统生成新变量，不会原地修改。  </p>
<hr>
<h2 id="5-预定义路径变量（必须熟）"><a href="#5-预定义路径变量（必须熟）" class="headerlink" title="5. 预定义路径变量（必须熟）"></a>5. 预定义路径变量（必须熟）</h2><table>
<thead>
<tr>
<th>变量</th>
<th>解释</th>
<th>典型值</th>
</tr>
</thead>
<tbody><tr>
<td><code>CMAKE_SOURCE_DIR</code></td>
<td>顶层 CMakeLists.txt 所在源码根</td>
<td><code>/home/user/demo</code></td>
</tr>
<tr>
<td><code>CMAKE_CURRENT_SOURCE_DIR</code></td>
<td>当前 CMakeLists 所在源码目录</td>
<td><code>/home/user/demo/Core</code></td>
</tr>
<tr>
<td><code>CMAKE_BINARY_DIR</code></td>
<td>顶层构建目录</td>
<td><code>/home/user/demo/build</code></td>
</tr>
<tr>
<td><code>CMAKE_CURRENT_BINARY_DIR</code></td>
<td>当前子目录构建目录</td>
<td><code>/home/user/demo/build/Core</code></td>
</tr>
<tr>
<td><code>PROJECT_SOURCE_DIR</code></td>
<td>定义 project() 的目录</td>
<td>同 CMAKE_SOURCE_DIR</td>
</tr>
<tr>
<td><code>CMAKE_INSTALL_PREFIX</code></td>
<td>安装目标根目录</td>
<td><code>/usr/local</code> 或手动 -prefix</td>
</tr>
<tr>
<td><code>CMAKE_RUNTIME_OUTPUT_DIRECTORY</code></td>
<td>可执行输出路径</td>
<td><code>$&#123;CMAKE_SOURCE_DIR&#125;/bin</code></td>
</tr>
<tr>
<td><code>CMAKE_LIBRARY_OUTPUT_DIRECTORY</code></td>
<td>动态库输出路径</td>
<td><code>$&#123;CMAKE_SOURCE_DIR&#125;/bin/lib</code></td>
</tr>
<tr>
<td><code>CMAKE_ARCHIVE_OUTPUT_DIRECTORY</code></td>
<td>静态库输出路径</td>
<td><code>$&#123;CMAKE_SOURCE_DIR&#125;/bin/lib</code></td>
</tr>
</tbody></table>
<p><strong>范例：</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/bin)</span><br><span class="line"><span class="keyword">add_executable</span>(app main.cpp)</span><br></pre></td></tr></table></figure>
<p>→ <code>bin/app</code> 生成在源码的 bin 目录。</p>
<hr>
<h2 id="6-路径与文件辅助变量"><a href="#6-路径与文件辅助变量" class="headerlink" title="6. 路径与文件辅助变量"></a>6. 路径与文件辅助变量</h2><table>
<thead>
<tr>
<th>变量</th>
<th>内容</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>CMAKE_CURRENT_FUNCTION_LIST_DIR</code></td>
<td>当前函数所在文件路径</td>
<td>模块内引入相对路径</td>
</tr>
<tr>
<td><code>CMAKE_COMMAND</code></td>
<td>当前 cmake 可执行路径</td>
<td>用于 add_custom_command 调用</td>
</tr>
<tr>
<td><code>CMAKE_MODULE_PATH</code></td>
<td>搜索 FindXXX.cmake 的额外目录</td>
<td><code>set(CMAKE_MODULE_PATH &quot;$&#123;CMAKE_SOURCE_DIR&#125;/cmake&quot;)</code></td>
</tr>
<tr>
<td><code>CMAKE_GENERATOR</code></td>
<td>当前生成器（Ninja &#x2F; Makefiles &#x2F; MSVC）</td>
<td>条件判断</td>
</tr>
<tr>
<td><code>CMAKE_SYSTEM_NAME</code></td>
<td>操作系统标识</td>
<td>交叉编译判断</td>
</tr>
<tr>
<td><code>CMAKE_CXX_COMPILER_ID</code></td>
<td>编译器标识</td>
<td>GCC &#x2F; Clang &#x2F; MSVC</td>
</tr>
<tr>
<td><code>CMAKE_BUILD_TYPE</code></td>
<td>构建类型</td>
<td>Debug &#x2F; Release …</td>
</tr>
</tbody></table>
<hr>
<h2 id="7-变量存在性与默认值处理"><a href="#7-变量存在性与默认值处理" class="headerlink" title="7. 变量存在性与默认值处理"></a>7. 变量存在性与默认值处理</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">DEFINED</span> VAR)</span><br><span class="line">  <span class="keyword">message</span>(<span class="string">&quot;VAR is defined&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> SOME_OPTION)</span><br><span class="line">  <span class="keyword">set</span>(SOME_OPTION <span class="keyword">OFF</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-高级技巧：父作用域-复合路径"><a href="#8-高级技巧：父作用域-复合路径" class="headerlink" title="8. 高级技巧：父作用域 &amp; 复合路径"></a>8. 高级技巧：父作用域 &amp; 复合路径</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在子函数修改外层值</span></span><br><span class="line"><span class="keyword">function</span>(setFlag)</span><br><span class="line">  <span class="keyword">set</span>(MODE ready PARENT_SCOPE)</span><br><span class="line"><span class="keyword">endfunction</span>()</span><br><span class="line">setFlag()</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;MODE=$&#123;MODE&#125;&quot;</span>)  <span class="comment"># → ready</span></span><br></pre></td></tr></table></figure>

<p>复合路径构建：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(DIR /home)</span><br><span class="line"><span class="keyword">set</span>(PATH <span class="variable">$&#123;DIR&#125;</span>/<span class="keyword">project</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-小结与常见误区"><a href="#9-小结与常见误区" class="headerlink" title="9. 小结与常见误区"></a>9. 小结与常见误区</h2><table>
<thead>
<tr>
<th>情形</th>
<th>问题</th>
<th>修复方式</th>
</tr>
</thead>
<tbody><tr>
<td>使用 <code>$VAR</code> 而非 <code>$&#123;VAR&#125;</code></td>
<td>解释为空字符串</td>
<td>始终加花括号</td>
</tr>
<tr>
<td>想改父作用域变量不起作用</td>
<td>function 有局部作用域</td>
<td>使用 PARENT_SCOPE</td>
</tr>
<tr>
<td>新文件未被检测到</td>
<td>使用 file(GLOB)</td>
<td>显式列源码或触发 reconfigure</td>
</tr>
<tr>
<td>想跨 build 保存设置</td>
<td>用 CACHE 变量</td>
<td><code>set(VAR val CACHE ...)</code></td>
</tr>
<tr>
<td>需要环境变量更新</td>
<td>需在执行命令前 set(ENV{})</td>
<td>否则已启动的构建不会继承</td>
</tr>
</tbody></table>
<hr>
<p>到此，第 1 章覆盖：</p>
<ul>
<li>变量定义与3种类型  </li>
<li>作用域与函数&#x2F;宏差异  </li>
<li>list &#x2F; string 常用操作  </li>
<li>预定义路径与系统变量  </li>
<li>缓存、环境及父作用域技巧</li>
</ul>
<hr>
<hr>
<h1 id="⚙️-第-2-章-CMake-目标-Target-体系与依赖机制全解"><a href="#⚙️-第-2-章-CMake-目标-Target-体系与依赖机制全解" class="headerlink" title="⚙️ 第 2 章 | CMake 目标 (Target) 体系与依赖机制全解"></a>⚙️ 第 2 章 | CMake 目标 (Target) 体系与依赖机制全解</h1><hr>
<h2 id="2-1-Target-是什么"><a href="#2-1-Target-是什么" class="headerlink" title="2.1 Target 是什么"></a>2.1 Target 是什么</h2><p>在 CMake 里，<strong>目标(Target)</strong> 是一种「可构建实体」。<br>每一个 <code>add_executable()</code>、<code>add_library()</code> 调用后，都会在内部产生一个 Target 对象，记录它的：</p>
<ul>
<li>源文件集合  </li>
<li>编译&#x2F;链接参数  </li>
<li>导出名称  </li>
<li>安装位置  </li>
<li>与其他 Target 的关系</li>
</ul>
<p>这些目标被编译工具（Ninja &#x2F; Makefile &#x2F; MSVC …）映射成真实的构建单元。<br>所有依赖关系、头文件路径、宏定义，最终都绑定在Target 上。</p>
<hr>
<h3 id="2-1-1-创建目标"><a href="#2-1-1-创建目标" class="headerlink" title="2.1.1 创建目标"></a>2.1.1 创建目标</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span>(app main.cpp)</span><br><span class="line"><span class="keyword">add_library</span>(core STATIC core.cpp)</span><br><span class="line"><span class="keyword">add_library</span>(net SHARED net.cpp)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>关键字</th>
<th>说明</th>
<th>输出形式</th>
</tr>
</thead>
<tbody><tr>
<td><code>STATIC</code></td>
<td>静态库</td>
<td>libcore.a &#x2F; core.lib</td>
</tr>
<tr>
<td><code>SHARED</code></td>
<td>动态库</td>
<td>libnet.so &#x2F; net.dll</td>
</tr>
<tr>
<td><code>MODULE</code></td>
<td>插件模块库</td>
<td>仅 <code>dlopen</code>&#x2F;<code>LoadLibrary</code> 调用加载</td>
</tr>
<tr>
<td><em>(无类型)</em></td>
<td>由变量 <code>BUILD_SHARED_LIBS</code> 控制</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>⚙️ <code>add_library(core core.cpp)</code> 会在变量 <code>BUILD_SHARED_LIBS</code> 为 ON 时自动生成共享库。  </p>
</blockquote>
<hr>
<h3 id="2-1-2-目标命名与路径属性"><a href="#2-1-2-目标命名与路径属性" class="headerlink" title="2.1.2 目标命名与路径属性"></a>2.1.2 目标命名与路径属性</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set_target_properties</span>(core PROPERTIES</span><br><span class="line">  OUTPUT_NAME <span class="string">&quot;MyCore&quot;</span>            <span class="comment"># 生成文件名</span></span><br><span class="line">  ARCHIVE_OUTPUT_DIRECTORY lib    <span class="comment"># 静态库路径</span></span><br><span class="line">  LIBRARY_OUTPUT_DIRECTORY lib    <span class="comment"># 动态库路径</span></span><br><span class="line">  RUNTIME_OUTPUT_DIRECTORY bin    <span class="comment"># 可执行输出路径</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>📘 属性控制单个目标的生成行为。可随时 <code>get_target_property()</code> 读取。</p>
<hr>
<h2 id="2-2-target-link-libraries：建立依赖关系"><a href="#2-2-target-link-libraries：建立依赖关系" class="headerlink" title="2.2 target_link_libraries：建立依赖关系"></a>2.2 target_link_libraries：建立依赖关系</h2><p>这是最常用命令，用于告诉 CMake 如何把一个目标连接到另一个目标或系统库。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE core pthread)</span><br></pre></td></tr></table></figure>

<p><strong>完整语法：</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(&lt;<span class="keyword">target</span>&gt;</span><br><span class="line">  [PRIVATE|PUBLIC|INTERFACE] &lt;item&gt; [&lt;item&gt;...])</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>关键字</th>
<th>说明</th>
<th>传播方式</th>
</tr>
</thead>
<tbody><tr>
<td>PRIVATE</td>
<td>仅当前目标生效</td>
<td>不传播</td>
</tr>
<tr>
<td>PUBLIC</td>
<td>当前目标及其依赖的下游目标</td>
<td>传播</td>
</tr>
<tr>
<td>INTERFACE</td>
<td>本目标不使用，但下游使用</td>
<td>仅传播</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(A a.cpp)</span><br><span class="line"><span class="keyword">add_library</span>(B b.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(B PUBLIC A)</span><br><span class="line"><span class="keyword">add_executable</span>(app main.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE B)</span><br><span class="line"><span class="comment"># app 自动获得对 A 的链接：B 公布了 A 作为 PUBLIC 依赖</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="常见场景举例"><a href="#常见场景举例" class="headerlink" title="常见场景举例"></a>常见场景举例</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Header-only 库</span></span><br><span class="line"><span class="keyword">add_library</span>(utils INTERFACE)</span><br><span class="line"><span class="keyword">target_include_directories</span>(utils INTERFACE <span class="keyword">include</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 普通库应用</span></span><br><span class="line"><span class="keyword">add_library</span>(core src/core.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(app main.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE core utils)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-3-target-include-directories：头文件路径"><a href="#2-3-target-include-directories：头文件路径" class="headerlink" title="2.3 target_include_directories：头文件路径"></a>2.3 target_include_directories：头文件路径</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_include_directories</span>(core</span><br><span class="line">  PUBLIC <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>修饰符</th>
<th>作用范围</th>
</tr>
</thead>
<tbody><tr>
<td>PRIVATE</td>
<td>本目标可见</td>
</tr>
<tr>
<td>INTERFACE</td>
<td>仅依赖者可见</td>
</tr>
<tr>
<td>PUBLIC</td>
<td>两者都可见</td>
</tr>
</tbody></table>
<p>📘 推荐做法：每个库在自己的 CMakeLists 里通过 target_include_directories 公布路径，而不是全局 include_directories()。  </p>
<hr>
<h2 id="2-4-target-compile-definitions：编译宏"><a href="#2-4-target-compile-definitions：编译宏" class="headerlink" title="2.4 target_compile_definitions：编译宏"></a>2.4 target_compile_definitions：编译宏</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_compile_definitions</span>(core</span><br><span class="line">  PRIVATE CORE_EXPORTS</span><br><span class="line">  PUBLIC CORE_API_LEVEL=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>相当于编译命令中增加 <code>-DCORE_EXPORTS</code> &#x2F; <code>-DCORE_API_LEVEL=2</code>。<br>使用修饰符控制传播范围。</p>
<hr>
<h2 id="2-5-target-compile-options：添加编译器标志"><a href="#2-5-target-compile-options：添加编译器标志" class="headerlink" title="2.5 target_compile_options：添加编译器标志"></a>2.5 target_compile_options：添加编译器标志</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_compile_options</span>(core PRIVATEWall -Wextra)</span><br><span class="line"><span class="keyword">target_compile_options</span>(app PUBLIC -O2)</span><br></pre></td></tr></table></figure>

<ul>
<li>可为不同目标定义不同编译参数；  </li>
<li>支持 PRIVATE &#x2F; PUBLIC 同样修饰词。</li>
</ul>
<hr>
<h2 id="2-6-目标属性-与-get-set"><a href="#2-6-目标属性-与-get-set" class="headerlink" title="2.6 目标属性 与 get&#x2F;set"></a>2.6 目标属性 与 get&#x2F;set</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set_target_properties</span>(app PROPERTIES CXX_STANDARD <span class="number">17</span>)</span><br><span class="line"><span class="keyword">get_target_property</span>(standard app CXX_STANDARD)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;C++ standard for app = $&#123;standard&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>常用属性：</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>功能</th>
<th>取值</th>
</tr>
</thead>
<tbody><tr>
<td>CXX_STANDARD</td>
<td>++ 标准版本</td>
<td>11 &#x2F; 14 &#x2F; 17 &#x2F; 20 …</td>
</tr>
<tr>
<td>POSITION_INDEPENDENT_CODE</td>
<td>控制 fPIC</td>
<td>ON &#x2F; OFF</td>
</tr>
<tr>
<td>LINKER_LANGUAGE</td>
<td>指定链接语言</td>
<td>C &#x2F; CXX</td>
</tr>
<tr>
<td>OUTPUT_NAME</td>
<td>输出名</td>
<td>例如 MyApp</td>
</tr>
</tbody></table>
<hr>
<h2 id="2-7-导入与接口目标"><a href="#2-7-导入与接口目标" class="headerlink" title="2.7 导入与接口目标"></a>2.7 导入与接口目标</h2><h3 id="2-7-1-IMPORTED"><a href="#2-7-1-IMPORTED" class="headerlink" title="2.7.1 IMPORTED"></a>2.7.1 IMPORTED</h3><p>代表外部已存在的库，不参与构建：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(MyExternal UNKNOWN IMPORTED)</span><br><span class="line"><span class="keyword">set_target_properties</span>(MyExternal PROPERTIES</span><br><span class="line">  IMPORTED_LOCATION /usr/lib/libext.so</span><br><span class="line">  INTERFACE_INCLUDE_DIRECTORIES /usr/<span class="keyword">include</span>/ext)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE MyExternal)</span><br></pre></td></tr></table></figure>

<h3 id="2-7-2-INTERFACE"><a href="#2-7-2-INTERFACE" class="headerlink" title="2.7.2 INTERFACE"></a>2.7.2 INTERFACE</h3><p>Header‑only 或纯接口目标：  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(header_only INTERFACE)</span><br><span class="line"><span class="keyword">target_include_directories</span>(header_only INTERFACE <span class="keyword">include</span>)</span><br></pre></td></tr></table></figure>

<p>不会编译，只有接口属性。</p>
<hr>
<h2 id="2-8-命名空间-NAMESPACE"><a href="#2-8-命名空间-NAMESPACE" class="headerlink" title="2.8 命名空间 (NAMESPACE)"></a>2.8 命名空间 (NAMESPACE)</h2><p>CMake 建议为导出的 target 使用「命名空间::名称」格式。<br>例如 <code>find_package(OpenCV)</code> 后可使用：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE OpenCV::core)</span><br></pre></td></tr></table></figure>

<p>当你自己的项目导出时，同样可定义：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(<span class="keyword">EXPORT</span> MyProjTargets</span><br><span class="line">  NAMESPACE MyProj::</span><br><span class="line">  DESTINATION lib/cmake/MyProj)</span><br></pre></td></tr></table></figure>
<p>使用方：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(MyProj)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE MyProj::core)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-9-常见错误与排查"><a href="#2-9-常见错误与排查" class="headerlink" title="2.9 常见错误与排查"></a>2.9 常见错误与排查</h2><table>
<thead>
<tr>
<th>问题</th>
<th>现象</th>
<th>解决</th>
</tr>
</thead>
<tbody><tr>
<td>未找到某库</td>
<td>链接阶段 undefined reference</td>
<td>确认 target_link_libraries 顺序与修饰符</td>
</tr>
<tr>
<td>include 无效</td>
<td>编译时报头找不到</td>
<td>检查 target_include_directories 修饰符</td>
</tr>
<tr>
<td>属性未生效</td>
<td>语法正确但不执行</td>
<td>状态是否设置到正确目标</td>
</tr>
<tr>
<td>无法导出 INTERFACE 目标</td>
<td>错误提示 “target not built”</td>
<td>加上 EXPORT 和 install(EXPORT …) 一起使用</td>
</tr>
</tbody></table>
<hr>
<h2 id="2-10-章节小结"><a href="#2-10-章节小结" class="headerlink" title="2.10 章节小结"></a>2.10 章节小结</h2><blockquote>
<p>一切编译与链接信息都绑定在 Target 对象上。  </p>
</blockquote>
<p><strong>构建依赖链：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add_library(A)</span><br><span class="line">add_library(B)</span><br><span class="line">target_link_libraries(B PUBLIC A)</span><br><span class="line">add_executable(app)</span><br><span class="line">target_link_libraries(app PRIVATE B)</span><br></pre></td></tr></table></figure>
<p>🔁 CMake 自动推导 app → B → A 完整依赖；<br>头文件路径与宏定义按 PUBLIC&#x2F;INTERFACE 传播。</p>
<hr>
<p>🟢 第 2 章讲完，现在你拥有：</p>
<ul>
<li>完整 Target 定义方式  </li>
<li>链接依赖的三层修饰符语义  </li>
<li>include &#x2F; compile &#x2F; macro 属性绑定  </li>
<li>导入目标与命名空间理解</li>
</ul>
<hr>
<hr>
<h1 id="🧩-第-3-章-install-与-export-机制详解"><a href="#🧩-第-3-章-install-与-export-机制详解" class="headerlink" title="🧩 第 3 章 | install() 与 export() 机制详解"></a>🧩 第 3 章 | install() 与 export() 机制详解</h1><hr>
<h2 id="3-1-为什么要-install"><a href="#3-1-为什么要-install" class="headerlink" title="3.1 为什么要 install()"></a>3.1 为什么要 install()</h2><blockquote>
<p>构建器产物 (可执行文件、静态&#x2F;动态库、头文件等) 一般会分发给其他项目或用户使用，<br>CMake 的 <code>install()</code> 用于定义“哪些文件、放到哪里、装成什么结构”。</p>
</blockquote>
<hr>
<h2 id="3-2-基本语法分类"><a href="#3-2-基本语法分类" class="headerlink" title="3.2 基本语法分类"></a>3.2 基本语法分类</h2><ol>
<li><strong>安装目标</strong><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(TARGETS &lt;targets&gt; [<span class="keyword">EXPORT</span> &lt;<span class="keyword">export</span>-<span class="keyword">set</span>&gt;]</span><br><span class="line">        [RUNTIME DESTINATION &lt;dir&gt;]</span><br><span class="line">        [LIBRARY DESTINATION &lt;dir&gt;]</span><br><span class="line">        [ARCHIVE DESTINATION &lt;dir&gt;]</span><br><span class="line">        [PUBLIC_HEADER DESTINATION &lt;dir&gt;]</span><br><span class="line">        [INCLUDES DESTINATION &lt;dir&gt;])</span><br></pre></td></tr></table></figure></li>
<li><strong>安装普通文件</strong><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(FILES &lt;files&gt; DESTINATION &lt;dir&gt;)</span><br></pre></td></tr></table></figure></li>
<li><strong>安装整个目录</strong><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(DIRECTORY &lt;path&gt; DESTINATION &lt;dir&gt; [FILES_MATCHING PATTERN <span class="string">&quot;*.h&quot;</span>])</span><br></pre></td></tr></table></figure></li>
<li><strong>安装导出清单（生成 Config 包）</strong><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(<span class="keyword">EXPORT</span> &lt;<span class="keyword">export</span>-<span class="keyword">set</span>&gt;</span><br><span class="line">        <span class="keyword">FILE</span> &lt;config.cmake&gt;</span><br><span class="line">        NAMESPACE &lt;ns&gt;::</span><br><span class="line">        DESTINATION &lt;path&gt;)</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-3-主要参数说明"><a href="#3-3-主要参数说明" class="headerlink" title="3.3 主要参数说明"></a>3.3 主要参数说明</h2><table>
<thead>
<tr>
<th>子关键字</th>
<th>说明</th>
<th>典型内容</th>
</tr>
</thead>
<tbody><tr>
<td><strong>RUNTIME</strong></td>
<td>可执行文件输出路径</td>
<td><code>$&#123;CMAKE_INSTALL_BINDIR&#125;</code> (<code>bin</code>)</td>
</tr>
<tr>
<td><strong>LIBRARY</strong></td>
<td>动态库(<code>.so/.dll</code>)路径</td>
<td><code>$&#123;CMAKE_INSTALL_LIBDIR&#125;</code></td>
</tr>
<tr>
<td><strong>ARCHIVE</strong></td>
<td>静态库(<code>.a/.lib</code>)路径</td>
<td>同上</td>
</tr>
<tr>
<td><strong>PUBLIC_HEADER</strong></td>
<td>公共头文件安装目录</td>
<td><code>$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</code></td>
</tr>
<tr>
<td><strong>INCLUDES</strong></td>
<td>头文件包含目录提示</td>
<td>供 <code>EXPORT</code> 生成信息使用</td>
</tr>
</tbody></table>
<p>🧠 提示：<br><code>include(GNUInstallDirs)</code> 可获得标准目录变量，如 <code>CMAKE_INSTALL_BINDIR</code>、<code>LIBDIR</code>、<code>INCLUDEDIR</code> 等，便于跨平台统一。</p>
<hr>
<h2 id="3-4-示例：安装库与可执行文件"><a href="#3-4-示例：安装库与可执行文件" class="headerlink" title="3.4 示例：安装库与可执行文件"></a>3.4 示例：安装库与可执行文件</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(GNUInstallDirs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(core SHARED core.cpp)</span><br><span class="line"><span class="keyword">target_include_directories</span>(core PUBLIC <span class="keyword">include</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(app main.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE core)</span><br><span class="line"></span><br><span class="line"><span class="keyword">install</span>(TARGETS core app</span><br><span class="line">  RUNTIME DESTINATION <span class="variable">$&#123;CMAKE_INSTALL_BINDIR&#125;</span></span><br><span class="line">  LIBRARY DESTINATION <span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span></span><br><span class="line">  ARCHIVE DESTINATION <span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span></span><br><span class="line">  PUBLIC_HEADER DESTINATION <span class="variable">$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</span>/core)</span><br></pre></td></tr></table></figure>

<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --install build --prefix ./install</span><br></pre></td></tr></table></figure>

<p>输出结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">install/</span><br><span class="line">├─ bin/app</span><br><span class="line">├─ lib/libcore.so</span><br><span class="line">└─ include/core/core.h</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-5-install-EXPORT-生成-Config-包"><a href="#3-5-install-EXPORT-生成-Config-包" class="headerlink" title="3.5 install(EXPORT) 生成 Config 包"></a>3.5 install(EXPORT) 生成 Config 包</h2><p>让别的项目可以：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(MyProj REQUIRED)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(other PRIVATE MyProj::core)</span><br></pre></td></tr></table></figure>

<p>就必须导出自身的目标描述文件。</p>
<h3 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h3><p>1️⃣ 注册导出清单名：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(TARGETS core <span class="keyword">EXPORT</span> MyProjTargets</span><br><span class="line">        LIBRARY DESTINATION <span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span></span><br><span class="line">        PUBLIC_HEADER DESTINATION <span class="variable">$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</span>/core)</span><br></pre></td></tr></table></figure>
<p>2️⃣ 写出清单到 cmake&#x2F; 目录：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(<span class="keyword">EXPORT</span> MyProjTargets</span><br><span class="line">        <span class="keyword">FILE</span> MyProjTargets.cmake</span><br><span class="line">        NAMESPACE MyProj::</span><br><span class="line">        DESTINATION <span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/MyProj)</span><br></pre></td></tr></table></figure>
<p>3️⃣ 生成顶层 Config 文件（可选）：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">configure_file</span>(MyProjConfig.cmake.in</span><br><span class="line">               <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjConfig.cmake&quot;</span> @ONLY)</span><br><span class="line"><span class="keyword">install</span>(FILES <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjConfig.cmake&quot;</span></span><br><span class="line">        DESTINATION <span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>/cmake/MyProj)</span><br></pre></td></tr></table></figure>

<p>之后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --install build --prefix ./package</span><br></pre></td></tr></table></figure>
<p>另一个工程中：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(MyProj_DIR <span class="string">&quot;/path/to/package/lib/cmake/MyProj&quot;</span>)</span><br><span class="line"><span class="keyword">find_package</span>(MyProj)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(userApp PRIVATE MyProj::core)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-6-导出清单与命名空间（NAMESPACE）"><a href="#3-6-导出清单与命名空间（NAMESPACE）" class="headerlink" title="3.6 导出清单与命名空间（NAMESPACE）"></a>3.6 导出清单与命名空间（NAMESPACE）</h2><ul>
<li><code>EXPORT &lt;name&gt;</code> 只是一个收集器清单。  </li>
<li><code>NAMESPACE</code> 定义导入目标前缀，用于防止命名冲突。</li>
</ul>
<p>示例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(<span class="keyword">EXPORT</span> MathKitTargets</span><br><span class="line">        <span class="keyword">FILE</span> MathKitConfig.cmake</span><br><span class="line">        NAMESPACE MathKit::</span><br><span class="line">        DESTINATION lib/cmake/MathKit)</span><br></pre></td></tr></table></figure>

<p>消费者工程即可安全调用：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE MathKit::algebra)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-7-install-FILES-DIRECTORY-常规用途"><a href="#3-7-install-FILES-DIRECTORY-常规用途" class="headerlink" title="3.7 install(FILES | DIRECTORY) 常规用途"></a>3.7 install(FILES | DIRECTORY) 常规用途</h2><table>
<thead>
<tr>
<th>命令</th>
<th>用途</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>FILES</td>
<td>安装若干文件</td>
<td><code>install(FILES config.toml DESTINATION etc)</code></td>
</tr>
<tr>
<td>DIRECTORY</td>
<td>拷贝整个目录</td>
<td><code>install(DIRECTORY shaders DESTINATION share)</code></td>
</tr>
<tr>
<td>DIRECTORY + 过滤</td>
<td>仅匹配特定文件</td>
<td><code>install(DIRECTORY include/ DESTINATION include FILES_MATCHING PATTERN &quot;*.h&quot;)</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="3-8-配置文件模板-configure-file"><a href="#3-8-配置文件模板-configure-file" class="headerlink" title="3.8 配置文件模板 configure_file()"></a>3.8 配置文件模板 configure_file()</h2><p>在 install 生成 Config 过程中常需要写入路径信息。  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">configure_file</span>(</span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_SOURCE_DIR&#125;/cmake/MyProjConfig.cmake.in&quot;</span></span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_BINARY_DIR&#125;/MyProjConfig.cmake&quot;</span></span><br><span class="line">  @ONLY)</span><br></pre></td></tr></table></figure>

<p><strong>模板内容示意：</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MyProjConfig.cmake.in</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;$&#123;CMAKE_CURRENT_LIST_DIR&#125;/MyProjTargets.cmake&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(MyProj_VERSION <span class="string">&quot;@PROJECT_VERSION@&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>其中 <code>@PROJECT_VERSION@</code> 等占位符会被替换。</p>
<hr>
<h2 id="3-9-常见-install-变量"><a href="#3-9-常见-install-变量" class="headerlink" title="3.9 常见 install 变量"></a>3.9 常见 install 变量</h2><table>
<thead>
<tr>
<th>变量</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>CMAKE_INSTALL_PREFIX</code></td>
<td>安装根路径</td>
</tr>
<tr>
<td><code>CMAKE_INSTALL_BINDIR</code></td>
<td>默认 <code>bin</code></td>
</tr>
<tr>
<td><code>CMAKE_INSTALL_LIBDIR</code></td>
<td>默认 <code>lib</code> &#x2F; <code>lib64</code></td>
</tr>
<tr>
<td><code>CMAKE_INSTALL_INCLUDEDIR</code></td>
<td>默认 <code>include</code></td>
</tr>
<tr>
<td><code>CMAKE_INSTALL_DATADIR</code></td>
<td><code>share</code></td>
</tr>
<tr>
<td><code>CMAKE_INSTALL_SYSCONFDIR</code></td>
<td><code>etc</code></td>
</tr>
</tbody></table>
<p>命令行覆写：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --install build --prefix /opt/MyProj</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-10-常见问题-Q-A"><a href="#3-10-常见问题-Q-A" class="headerlink" title="3.10 常见问题 Q&amp;A"></a>3.10 常见问题 Q&amp;A</h2><table>
<thead>
<tr>
<th>问题</th>
<th>原因</th>
<th>解决</th>
</tr>
</thead>
<tbody><tr>
<td>安装路径不对</td>
<td>忘记包含 GNUInstallDirs</td>
<td><code>include(GNUInstallDirs)</code></td>
</tr>
<tr>
<td>find_package 找不到</td>
<td>未生成 Config.cmake</td>
<td>请加 install(EXPORT…)</td>
</tr>
<tr>
<td>Header 未随库安装</td>
<td>未指定 PUBLIC_HEADER&#x2F;FILES 或路径错误</td>
<td>确认 目标 PUBLIC_HEADER 或显式 install(FILES)</td>
</tr>
<tr>
<td>namespace 失效</td>
<td>没在 install(EXPORT) 里声明 NAMESPACE</td>
<td>补加 NAMESPACE MyProj::</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-11-章节小结"><a href="#3-11-章节小结" class="headerlink" title="3.11 章节小结"></a>3.11 章节小结</h2><p>✅ 本章你应掌握：</p>
<ul>
<li>install 三大用法: (TARGETS &#x2F; FILES &#x2F; DIRECTORY)  </li>
<li>export 导出机制 + 生成 Config 包步骤  </li>
<li>GNUInstallDirs 标准路径集合  </li>
<li>namespace 的意义与使用  </li>
<li>常见错误定位</li>
</ul>
<hr>
<hr>
<h1 id="🔍-第-4-章-find-package-与-CMake-包（Package）机制实战"><a href="#🔍-第-4-章-find-package-与-CMake-包（Package）机制实战" class="headerlink" title="🔍 第 4 章 | find_package() 与 CMake 包（Package）机制实战"></a>🔍 第 4 章 | find_package() 与 CMake 包（Package）机制实战</h1><hr>
<h2 id="4-1-find-package-的使命"><a href="#4-1-find-package-的使命" class="headerlink" title="4.1 find_package 的使命"></a>4.1 find_package 的使命</h2><blockquote>
<p>CMake 允许你复用外部库，但它必须<strong>知道怎么找到这些库</strong>。<br><code>find_package()</code> 就是连接项目依赖与实际路径的桥梁。  </p>
</blockquote>
<p>它会去系统路径及用户指定路径搜索匹配的描述文件来定位并导入库的 Targets。  </p>
<hr>
<h2 id="4-2-两种包模式"><a href="#4-2-两种包模式" class="headerlink" title="4.2 两种包模式"></a>4.2 两种包模式</h2><table>
<thead>
<tr>
<th>模式</th>
<th>文件类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Config 模式</strong></td>
<td><code>&lt;Name&gt;Config.cmake</code> &#x2F; <code>&lt;Name&gt;-config.cmake</code></td>
<td>推荐、现代项目（使用 target）导出使用</td>
</tr>
<tr>
<td><strong>Module 模式</strong></td>
<td><code>Find&lt;Name&gt;.cmake</code></td>
<td>传统手写搜索脚本</td>
</tr>
</tbody></table>
<p><code>find_package(MyProj)</code> 依次尝试：<br>1️⃣ 在路径中查找 <code>MyProjConfig.cmake</code> 或 <code>MyProj-config.cmake</code>;<br>2️⃣ 若找不到，再查是否有 <code>FindMyProj.cmake</code> 模块。  </p>
<hr>
<h2 id="4-3-Config-模式工作原理"><a href="#4-3-Config-模式工作原理" class="headerlink" title="4.3 Config 模式工作原理"></a>4.3 Config 模式工作原理</h2><p>当我们上一章通过  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(<span class="keyword">EXPORT</span> MyProjTargets</span><br><span class="line">        <span class="keyword">FILE</span> MyProjTargets.cmake</span><br><span class="line">        NAMESPACE MyProj::</span><br><span class="line">        DESTINATION lib/cmake/MyProj)</span><br><span class="line"><span class="keyword">install</span>(FILES MyProjConfig.cmake DESTINATION lib/cmake/MyProj)</span><br><span class="line">```  </span><br><span class="line">生成这些文件后，  </span><br><span class="line">外部项目调用：</span><br><span class="line"></span><br><span class="line">```cmake</span><br><span class="line"><span class="keyword">find_package</span>(MyProj REQUIRED)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE MyProj::core)</span><br></pre></td></tr></table></figure>

<p>CMake 查找顺序（简略）：</p>
<ol>
<li>变量 <code>MyProj_DIR</code> 指定的目录  </li>
<li>系统路径 <code>/usr/lib/cmake/MyProj</code> 等  </li>
<li>用户自定义包注册路径</li>
</ol>
<p>找到 <code>MyProjConfig.cmake</code> 后，该文件执行 <code>include(MyProjTargets.cmake)</code> ，从而导入 MyProj::core。  </p>
<hr>
<h3 id="4-3-1-Config-文件模板快速示例"><a href="#4-3-1-Config-文件模板快速示例" class="headerlink" title="4.3.1 Config 文件模板快速示例"></a>4.3.1 Config 文件模板快速示例</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MyProjConfig.cmake.in</span></span><br><span class="line">@PACKAGE_INIT@</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;$&#123;CMAKE_CURRENT_LIST_DIR&#125;/MyProjTargets.cmake&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(MyProj_VERSION <span class="string">&quot;@PROJECT_VERSION@&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>生成：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">configure_package_config_file(</span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/MyProjConfig.cmake.in&quot;</span></span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjConfig.cmake&quot;</span></span><br><span class="line">  INSTALL_DESTINATION lib/cmake/MyProj)</span><br><span class="line"><span class="keyword">install</span>(FILES <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjConfig.cmake&quot;</span></span><br><span class="line">        DESTINATION lib/cmake/MyProj)</span><br></pre></td></tr></table></figure>

<p>📘 <code>configure_package_config_file</code> 是官方宏（来自 CMakePackageConfigHelpers），<br>会自动填充版本与路径等信息。</p>
<hr>
<h2 id="4-4-Find-模式工作原理"><a href="#4-4-Find-模式工作原理" class="headerlink" title="4.4 Find 模式工作原理"></a>4.4 Find 模式工作原理</h2><p>旧式项目或系统库通常只提供 <code>FindXXX.cmake</code>：</p>
<p>存放在 <code>$CMAKE_MODULE_PATH</code> &#x2F; 系统 Modules 路径下。  </p>
<p>示例（系统自带）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FindThreads.cmake</span><br><span class="line">FindPkgConfig.cmake</span><br><span class="line">FindOpenGL.cmake</span><br><span class="line">FindPython3.cmake</span><br></pre></td></tr></table></figure>

<p>内部基本流程：</p>
<ol>
<li>尝试使用 pkg-config、系统变量、默认路径搜索头文件与库；</li>
<li>若成功设置以下变量：<ul>
<li><code>&lt;Pkg&gt;_FOUND</code></li>
<li><code>&lt;Pkg&gt;_INCLUDE_DIRS</code></li>
<li><code>&lt;Pkg&gt;_LIBRARIES</code></li>
</ul>
</li>
<li>使用示例：<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(OpenGL REQUIRED)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE OpenGL::GL)</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="4-5-搜索路径与控制变量"><a href="#4-5-搜索路径与控制变量" class="headerlink" title="4.5 搜索路径与控制变量"></a>4.5 搜索路径与控制变量</h2><table>
<thead>
<tr>
<th>变量 &#x2F;选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;Pkg&gt;_DIR</code></td>
<td>指定 Config 文件目录</td>
</tr>
<tr>
<td><code>CMAKE_PREFIX_PATH</code></td>
<td>附加搜索根</td>
</tr>
<tr>
<td><code>CMAKE_MODULE_PATH</code></td>
<td>附加模块搜索路径</td>
</tr>
<tr>
<td><code>CMAKE_FIND_ROOT_PATH</code></td>
<td>交叉编译根路径</td>
</tr>
<tr>
<td><code>NO_DEFAULT_PATH</code></td>
<td>关闭默认路径搜索</td>
</tr>
<tr>
<td><code>PATHS</code> &#x2F; <code>HINTS</code></td>
<td>临时指明候选路径</td>
</tr>
</tbody></table>
<p>💡 常用例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_PREFIX_PATH <span class="string">&quot;/opt/mylibs;/usr/local&quot;</span>)</span><br><span class="line"><span class="keyword">find_package</span>(MyProj REQUIRED)</span><br></pre></td></tr></table></figure>
<p>或命令行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_PREFIX_PATH=/opt/mylibs ..</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-6-版本与可选项"><a href="#4-6-版本与可选项" class="headerlink" title="4.6 版本与可选项"></a>4.6 版本与可选项</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Qt6 <span class="number">6.5</span> COMPONENTS Core Gui Widgets REQUIRED)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><strong><code>&lt;Name&gt;</code></strong></td>
<td>包名</td>
</tr>
<tr>
<td><strong><code>&lt;Version&gt;</code></strong></td>
<td>最低版本要求</td>
</tr>
<tr>
<td><strong>COMPONENTS</strong></td>
<td>指定子模块</td>
</tr>
<tr>
<td><strong>CONFIG &#x2F; MODULE</strong></td>
<td>指定搜索模式</td>
</tr>
<tr>
<td><strong>REQUIRED</strong></td>
<td>找不到则立即报错</td>
</tr>
<tr>
<td><strong>QUIET</strong></td>
<td>静默搜索，不提示</td>
</tr>
</tbody></table>
<p>Package 文件可提供：</p>
<ul>
<li><code>&lt;Name&gt;_FOUND</code></li>
<li><code>&lt;Name&gt;_VERSION</code></li>
<li><code>&lt;Name&gt;_COMPONENTS_FOUND</code></li>
</ul>
<hr>
<h2 id="4-7-CMakePackageConfigHelpers-工具"><a href="#4-7-CMakePackageConfigHelpers-工具" class="headerlink" title="4.7 CMakePackageConfigHelpers 工具"></a>4.7 CMakePackageConfigHelpers 工具</h2><p>提供两个核心宏：</p>
<ol>
<li><code>configure_package_config_file()</code>  </li>
<li><code>write_basic_package_version_file()</code></li>
</ol>
<p>生成基础 Config 与 Version 文件，让项目自动支持版本检测。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(CMakePackageConfigHelpers)</span><br><span class="line"></span><br><span class="line">write_basic_package_version_file(</span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjConfigVersion.cmake&quot;</span></span><br><span class="line">  VERSION <span class="variable">$&#123;PROJECT_VERSION&#125;</span></span><br><span class="line">  COMPATIBILITY SameMajorVersion)</span><br><span class="line"><span class="keyword">install</span>(FILES</span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjConfigVersion.cmake&quot;</span></span><br><span class="line">  DESTINATION lib/cmake/MyProj)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-8-跨平台-Find-实战举例"><a href="#4-8-跨平台-Find-实战举例" class="headerlink" title="4.8 跨平台 Find 实战举例"></a>4.8 跨平台 Find 实战举例</h2><h3 id="1-查找系统库-OpenSSL"><a href="#1-查找系统库-OpenSSL" class="headerlink" title="(1) 查找系统库 OpenSSL"></a>(1) 查找系统库 OpenSSL</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(OpenSSL REQUIRED)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE OpenSSL::SSL OpenSSL::Crypto)</span><br></pre></td></tr></table></figure>

<h3 id="2-查找自定义包路径"><a href="#2-查找自定义包路径" class="headerlink" title="(2) 查找自定义包路径"></a>(2) 查找自定义包路径</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(MyLib_DIR <span class="string">&quot;$&#123;CMAKE_SOURCE_DIR&#125;/third_party/mylib&quot;</span>)</span><br><span class="line"><span class="keyword">find_package</span>(MyLib CONFIG REQUIRED)</span><br></pre></td></tr></table></figure>

<h3 id="3-使用-pkg-config-模式"><a href="#3-使用-pkg-config-模式" class="headerlink" title="(3) 使用 pkg-config 模式"></a>(3) 使用 pkg-config 模式</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(PkgConfig REQUIRED)</span><br><span class="line">pkg_check_modules(ZLIB REQUIRED zlib)</span><br><span class="line"><span class="keyword">target_include_directories</span>(app PRIVATE <span class="variable">$&#123;ZLIB_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE <span class="variable">$&#123;ZLIB_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-9-查找优先级简化流程"><a href="#4-9-查找优先级简化流程" class="headerlink" title="4.9 查找优先级简化流程"></a>4.9 查找优先级简化流程</h2><p>1️⃣ 直接指定 <code>&lt;Pkg&gt;_DIR</code><br>2️⃣ 查 CMAKE_PREFIX_PATH<br>3️⃣ 查 系统默认路径 (&#x2F;usr&#x2F;lib&#x2F;cmake&#x2F;<Pkg>)<br>4️⃣ 查 CMAKE_MODULE_PATH<br>➡️ 最后 fallback 到内置 FindXXX.cmake  </p>
<hr>
<h2 id="4-10-常见问题与经验"><a href="#4-10-常见问题与经验" class="headerlink" title="4.10 常见问题与经验"></a>4.10 常见问题与经验</h2><table>
<thead>
<tr>
<th>问题</th>
<th>原因</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>包找不到</td>
<td>搜索路径未包含安装目录</td>
<td>设置 <code>&lt;Pkg&gt;_DIR</code> 或 <code>CMAKE_PREFIX_PATH</code></td>
</tr>
<tr>
<td>链接报错</td>
<td>未使用 target 接口</td>
<td>确保目标导出 namespace 并使用 target_link_libraries</td>
</tr>
<tr>
<td>找到了旧版本包</td>
<td>存在多个安装路径</td>
<td>显式指定版本或路径</td>
</tr>
<tr>
<td>“found false” 但头文件存在</td>
<td>无正确 Config 或 Find 模块</td>
<td>自己写 Find 脚本或切换 CONFIG 模式</td>
</tr>
<tr>
<td>交叉编译中找错体系库</td>
<td>PATH 未重定位</td>
<td>设置 <code>CMAKE_FIND_ROOT_PATH_MODE_*</code> 策略</td>
</tr>
</tbody></table>
<hr>
<h2 id="4-11-章节小结"><a href="#4-11-章节小结" class="headerlink" title="4.11 章节小结"></a>4.11 章节小结</h2><p>✅ 本章要点：  </p>
<ul>
<li><strong>两种包模式</strong>：Config (现代) vs Module (传统)  </li>
<li><strong>find_package</strong> 搜索路径与变量控制  </li>
<li><strong>Config&#x2F;Version</strong> 文件生成宏与使用  </li>
<li><strong>传播目标</strong>：通过 namespace 导出的 Target  </li>
<li><strong>常见错误排查方法</strong></li>
</ul>
<hr>
<hr>
<h1 id="🧱-第-5-多目录与子项目管理：add-subdirectory-与-FetchContent-实战"><a href="#🧱-第-5-多目录与子项目管理：add-subdirectory-与-FetchContent-实战" class="headerlink" title="🧱 第 5  | 多目录与子项目管理：add_subdirectory() 与 FetchContent 实战"></a>🧱 第 5  | 多目录与子项目管理：add_subdirectory() 与 FetchContent 实战</h1><hr>
<h2 id="5-1-多目录项目结构的意义"><a href="#5-1-多目录项目结构的意义" class="headerlink" title="5.1 多目录项目结构的意义"></a>5.1 多目录项目结构的意义</h2><p>当项目变大时，单个 CMakeLists.txt 已经难以维护。<br><strong>多层目录结构</strong>可以实现：</p>
<ul>
<li>模块化管理（库 core、网络 net、应用 app 分层）</li>
<li>组件独立编译、复用、单元测试</li>
<li>清晰的依赖链与作用域边界</li>
</ul>
<p>典型示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MyProj/</span><br><span class="line">├─ CMakeLists.txt            # 顶层</span><br><span class="line">├─ src/</span><br><span class="line">│  ├─ CMakeLists.txt         # 子目录构建核心库</span><br><span class="line">│  └─ core/</span><br><span class="line">│     ├─ CMakeLists.txt</span><br><span class="line">│     └─ core.cpp</span><br><span class="line">├─ app/</span><br><span class="line">│  ├─ CMakeLists.txt</span><br><span class="line">│  └─ main.cpp</span><br><span class="line">└─ tests/</span><br><span class="line">   └─ CMakeLists.txt</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-2-add-subdirectory"><a href="#5-2-add-subdirectory" class="headerlink" title="5.2 add_subdirectory()"></a>5.2 add_subdirectory()</h2><p>顶层 CMakeLists 中注册构建的子目录：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(app)</span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"><span class="keyword">add_subdirectory</span>(tests)</span><br></pre></td></tr></table></figure>

<p>语法：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add_sub(&lt;dir&gt; [binary_dir] [EXCLUDE_FROM_ALL])</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;dir&gt;</code></td>
<td>子目录相对路径</td>
</tr>
<tr>
<td><code>binary_dir</code></td>
<td>指定构建输出目录（默认 build 树内同路径）</td>
</tr>
<tr>
<td>&#96;EXCLUDE_FROM_ALL</td>
<td>子项目不会随主项目默认目标编译</td>
</tr>
</tbody></table>
<p>⚙️ 每个子目录都可以像独立项目一样使用 add_library、add_executable 等命令，<br>且继承顶层的 变量、缓存、选项。  </p>
<hr>
<h2 id="5-3-作用域与变量传播规则"><a href="#5-3-作用域与变量传播规则" class="headerlink" title="5.3 作用域与变量传播规则"></a>5.3 作用域与变量传播规则</h2><ul>
<li><strong>变量</strong>：<code>set(VAR value)</code> 默认只在当前文件和更低层 可见，除非声明 <code>CACHE</code> 或 <code>PARENT_SCOPE</code>。  </li>
<li><strong>目标</strong>：所有子目录 add_library&#x2F;add_executable 产生的 Target 在全局可见（可跨目录使用 target_link_libraries）。  </li>
<li>**选项(Option)**：顶层 option() 定义后，子目录都可 ON&#x2F;OFF 控制。</li>
</ul>
<p>例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 顶层</span></span><br><span class="line"><span class="keyword">option</span>(ENABLE_NET <span class="string">&quot;Build net module&quot;</span> <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">if</span>(ENABLE_NET)</span><br><span class="line">  <span class="keyword">add_subdirectory</span>(src/net)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-4-子项目间依赖"><a href="#5-4-子项目间依赖" class="headerlink" title="5.4 子项目间依赖"></a>5.4 子项目间依赖</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># src/core/CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_library</span>(core core.cpp core.h)</span><br><span class="line"><span class="keyword">target_include_directories</span>(core PUBLIC <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># app/CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_executable</span>(app main.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE core)</span><br></pre></td></tr></table></figure>
<p>⮕ 这样即可在顶层构建时自动按依赖顺序编译。</p>
<hr>
<h2 id="5-5-EXCLUDE-FROM-ALL-的使用场景"><a href="#5-5-EXCLUDE-FROM-ALL-的使用场景" class="headerlink" title="5.5 EXCLUDE_FROM_ALL 的使用场景"></a>5.5 EXCLUDE_FROM_ALL 的使用场景</h2><p>某些子模块（例如测试、工具）只在需要时编译:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(tools EXCLUDE_FROM_ALL)</span><br></pre></td></tr></table></figure>
<p>除非显式调用 <code>cmake --build . --target toolname</code>，否则不会参与默认 <code>all</code> 目标。</p>
<hr>
<h2 id="5-6-外部子项目管理方案一：add-subdirectory-FetchContent"><a href="#5-6-外部子项目管理方案一：add-subdirectory-FetchContent" class="headerlink" title="5.6 外部子项目管理方案一：add_subdirectory + FetchContent"></a>5.6 外部子项目管理方案一：add_subdirectory + FetchContent</h2><blockquote>
<p>“不安装外部依赖，也能达成跨项目构建”  </p>
</blockquote>
<p>从 CMake 3.11 开始提供的 <strong>FetchContent</strong> 模块，让你在配置阶段下载并添加外部源码。</p>
<hr>
<h3 id="5-6-1-基本流程"><a href="#5-6-1-基本流程" class="headerlink" title="5.6.1 基本流程"></a>5.6.1 基本流程</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(FetchContent)</span><br><span class="line"></span><br><span class="line">FetchContent_Declare(</span><br><span class="line">  spdlog</span><br><span class="line">  GIT_REPOSITORY https://github.com/gabime/spdlog.git</span><br><span class="line">  GIT_TAG        v1.<span class="number">11.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动下载 + add_subdirectory</span></span><br><span class="line">FetchContent_MakeAvailable(spdlog)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一旦执行后，你就可以直接：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE spdlog::spdlog)</span><br></pre></td></tr></table></figure>
<p>无需额外 find_package。</p>
</blockquote>
<hr>
<h3 id="5-6-2-可选参数"><a href="#5-6-2-可选参数" class="headerlink" title="5.6.2 可选参数"></a>5.6.2 可选参数</h3><table>
<thead>
<tr>
<th>关键字</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>URL</code> &#x2F; <code>URL_HASH</code></td>
<td>HTTP 包下载（zip&#x2F;tar.gz）</td>
</tr>
<tr>
<td><code>GIT_REPOSITORY</code> &#x2F; <code>GIT_TAG</code></td>
<td>Git 仓库源码</td>
</tr>
<tr>
<td><code>SOURCE_DIR</code></td>
<td>已有源码路径，可跳过下载</td>
</tr>
<tr>
<td><code>SYSTEM</code></td>
<td>将目录标记为系统库路径（避免警告）</td>
</tr>
</tbody></table>
<p>示例 — 下载 fmt：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FetchContent_Declare(fmt</span><br><span class="line">  URL https://github.com/fmtlib/fmt/archive/<span class="number">9.1</span>.<span class="number">0</span>.tar.gz)</span><br><span class="line">FetchContent_MakeAvailable(fmt)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-7-外部子项目管理方案二：ExternalProject-Add"><a href="#5-7-外部子项目管理方案二：ExternalProject-Add" class="headerlink" title="5.7 外部子项目管理方案二：ExternalProject_Add"></a>5.7 外部子项目管理方案二：ExternalProject_Add</h2><p>区别：  </p>
<ul>
<li><strong>ExternalProject_Add</strong> 在 <em>构建阶段</em> 下载并单独执行安装（不会直接作为子目录）。  </li>
<li><strong>FetchContent</strong> 在 <em>配置阶段</em> 下载并直接编入当前构建树。</li>
</ul>
<table>
<thead>
<tr>
<th>特性</th>
<th>FetchContent</th>
<th>ExternalProject_Add</th>
</tr>
</thead>
<tbody><tr>
<td>下载时机</td>
<td>配置阶段</td>
<td>构建阶段</td>
</tr>
<tr>
<td>是否变成本地 target</td>
<td>✅ 是（add_subdirectory）</td>
<td>❌ 独立</td>
</tr>
<tr>
<td>编译依赖自动传播</td>
<td>✅</td>
<td>❌（要手动导入）</td>
</tr>
<tr>
<td>用途</td>
<td>Header-only、小中型库</td>
<td>巨型工程、第三方工具链</td>
</tr>
</tbody></table>
<p>示意：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(ExternalProject)</span><br><span class="line">ExternalProject_Add(googletest</span><br><span class="line">  GIT_REPOSITORY https://github.com/google/googletest.git</span><br><span class="line">  GIT_TAG release-<span class="number">1.13</span>.<span class="number">0</span></span><br><span class="line">  PREFIX <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/_deps</span><br><span class="line">  INSTALL_COMMAND <span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-8-多目录项目实践示例"><a href="#5-8-多目录项目实践示例" class="headerlink" title="5.8 多目录项目实践示例"></a>5.8 多目录项目实践示例</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 顶层 CMakeLists.txt</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.22</span>)</span><br><span class="line"><span class="keyword">project</span>(MyProj VERSION <span class="number">1.0</span> LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(FetchContent)</span><br><span class="line">FetchContent_Declare(spdlog</span><br><span class="line">  GIT_REPOSITORY https://github.com/gabime/spdlog.git</span><br><span class="line">  GIT_TAG v1.<span class="number">11.0</span>)</span><br><span class="line">FetchContent_MakeAvailable(spdlog)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(app)</span><br></pre></td></tr></table></figure>

<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># src/CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_library</span>(core core.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(core PUBLIC spdlog::spdlog)</span><br></pre></td></tr></table></figure>

<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_executable</span>(app main.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE core)</span><br></pre></td></tr></table></figure>

<p>构建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -S . -B build</span><br><span class="line">cmake --build build -j</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-9-多目录组织经验"><a href="#5-9-多目录组织经验" class="headerlink" title="5.9 多目录组织经验"></a>5.9 多目录组织经验</h2><ul>
<li>每层的 CMakeLists.txt 职责清晰，尽量只描述当前层目标。  </li>
<li>变量和常量尽量在顶层设置（编译选项、全局定义等）。  </li>
<li>使用 <code>PRIVATE/PUBLIC/INTERFACE</code> 控制属性传播范围。  </li>
<li>大型项目建议配合 install&#x2F;export 生成统一 Config 包。  </li>
<li>外部依赖推荐 FetchContent 或 已经 Config 化 的库。  </li>
<li>若被多项目复用，可单独维护为 git 子模块 + add_subdirectory。</li>
</ul>
<hr>
<h2 id="5-10-章节小结"><a href="#5-10-章节小结" class="headerlink" title="5.10 章节小结"></a>5.10 章节小结</h2><p>✅ 本章掌握：</p>
<ul>
<li><strong>多目录结构</strong> 及其层次化管理模式  </li>
<li><strong>add_subdirectory</strong> 管理内部组件  </li>
<li><strong>作用域与变量传递规则</strong>  </li>
<li><strong>EXCLUDE_FROM_ALL</strong> 选项应用  </li>
<li><strong>FetchContent</strong> 快速拉取外部依赖  </li>
<li><strong>ExternalProject_Add</strong> 独立外部构建方案  </li>
<li>组织大型工程的常见建议</li>
</ul>
<hr>
<hr>
<h1 id="⚙️-第-6-章-构建类型（Debug-Release）与多配置、多平台策略"><a href="#⚙️-第-6-章-构建类型（Debug-Release）与多配置、多平台策略" class="headerlink" title="⚙️ 第 6 章 | 构建类型（Debug&#x2F;Release）与多配置、多平台策略"></a>⚙️ 第 6 章 | 构建类型（Debug&#x2F;Release）与多配置、多平台策略</h1><hr>
<h2 id="6-1-构建类型的核心概念"><a href="#6-1-构建类型的核心概念" class="headerlink" title="6.1 构建类型的核心概念"></a>6.1 构建类型的核心概念</h2><blockquote>
<p>“构建类型”决定编译优化级别、调试符号、宏定义等编译条件。<br>在 CMake 中，它由变量 <code>CMAKE_BUILD_TYPE</code> 或多配置生成器控制。  </p>
</blockquote>
<hr>
<h2 id="6-2-单配置生成器-🧩"><a href="#6-2-单配置生成器-🧩" class="headerlink" title="6.2 单配置生成器 🧩"></a>6.2 单配置生成器 🧩</h2><p>典型代表：<br>GCC、Clang、Makefiles、Ninja  </p>
<p>📄 在这种生成器下，构建类型通过变量  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</span><br><span class="line">```  </span><br><span class="line">在 **配置阶段固定**，接着编译时仅存在这一种。  </span><br><span class="line"></span><br><span class="line">| 常用构建类型 | 默认宏 | 优化状态 |</span><br><span class="line">|---------------|---------|----------|</span><br><span class="line">| Debug | `DEBUG`, `NDEBUG` 未定义 | 无优化 + 调试符号 |</span><br><span class="line">| Release | `NDEBUG` | 高优化、去符号 |</span><br><span class="line">| RelWithDebInfo | `NDEBUG` | 优化 + 调试符号 |</span><br><span class="line">| MinSizeRel | `NDEBUG` | 微优化体积 |</span><br><span class="line"></span><br><span class="line">可查看内置选项：</span><br><span class="line">```bash</span><br><span class="line">cmake --help-variable CMAKE_BUILD_TYPE</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-3-多配置生成器-🧩"><a href="#6-3-多配置生成器-🧩" class="headerlink" title="6.3 多配置生成器 🧩"></a>6.3 多配置生成器 🧩</h2><p>典型代表：<br>Visual Studio、Xcode、Ninja Multi-Config  </p>
<p>📦 在这种生成器中 CMake 一次生成所有配置，<br>构建时再指定配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake --build build --config Debug</span><br><span class="line">cmake --build build --config Release</span><br></pre></td></tr></table></figure>

<p>无需再设置 <code>CMAKE_BUILD_TYPE</code>。</p>
<hr>
<h2 id="6-4-定义自定义构建类型（进阶）"><a href="#6-4-定义自定义构建类型（进阶）" class="headerlink" title="6.4 定义自定义构建类型（进阶）"></a>6.4 定义自定义构建类型（进阶）</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_CONFIGURATION_TYPES <span class="string">&quot;Debug;Release;ASan&quot;</span> CACHE <span class="keyword">STRING</span> <span class="string">&quot;&quot;</span> FORCE)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS_ASan <span class="string">&quot;-fsanitize=address -O1 -g&quot;</span> CACHE <span class="keyword">STRING</span> <span class="string">&quot;&quot;</span> FORCE)</span><br></pre></td></tr></table></figure>

<p>在多配置下会多出 ASan 选项。</p>
<hr>
<h2 id="6-5-常见编译选项变量"><a href="#6-5-常见编译选项变量" class="headerlink" title="6.5 常见编译选项变量"></a>6.5 常见编译选项变量</h2><table>
<thead>
<tr>
<th>变量</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>CMAKE_C_FLAGS_&lt;CONFIG&gt;</code></td>
<td>C 语言特定编译选项</td>
</tr>
<tr>
<td><code>CMAKE_CXX_FLAGS_&lt;CONFIG&gt;</code></td>
<td>C++ 编译选项</td>
</tr>
<tr>
<td><code>&lt;LANG&gt;_COMPILER_LAUNCHER</code></td>
<td>包装器（ccache, distcc）</td>
</tr>
<tr>
<td><code>CMAKE_EXE_LINKER_FLAGS_&lt;CONFIG&gt;</code></td>
<td>链接器参数</td>
</tr>
<tr>
<td><code>CMAKE_&lt;LANG&gt;_FLAGS_INIT</code></td>
<td>默认初始值</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS_DEBUG <span class="string">&quot;-g -O0&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS_RELEASE <span class="string">&quot;-O3 -DNDEBUG&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-6-针对目标的生成器表达式"><a href="#6-6-针对目标的生成器表达式" class="headerlink" title="6.6 针对目标的生成器表达式"></a>6.6 针对目标的生成器表达式</h2><p>CMake 提供带 <code>$&lt;CONFIG:...&gt;</code> 的表达式区分配置：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_compile_definitions</span>(app PRIVATE</span><br><span class="line">  $&lt;$&lt;CONFIG:Debug&gt;:DEBUG_MODE&gt;</span><br><span class="line">  $&lt;$&lt;CONFIG:Release&gt;:NDEBUG&gt;)</span><br></pre></td></tr></table></figure>

<p>或路径区分：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_directories</span>(app PRIVATE</span><br><span class="line">  $&lt;$&lt;CONFIG:Debug&gt;:<span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/lib/Debug&gt;</span><br><span class="line">  $&lt;$&lt;CONFIG:Release&gt;:<span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/lib/Release&gt;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-7-跨平台变量与宏"><a href="#6-7-跨平台变量与宏" class="headerlink" title="6.7 跨平台变量与宏"></a>6.7 跨平台变量与宏</h2><table>
<thead>
<tr>
<th>平台宏</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>WIN32</code></td>
<td>Windows</td>
</tr>
<tr>
<td><code>UNIX</code> (含 macOS, Linux)</td>
<td>类 Unix</td>
</tr>
<tr>
<td><code>APPLE</code></td>
<td>macOS</td>
</tr>
<tr>
<td><code>MSVC</code></td>
<td>Microsoft VC 编译器</td>
</tr>
<tr>
<td><code>MINGW</code></td>
<td>MinGW</td>
</tr>
<tr>
<td><code>CMAKE_SYSTEM_NAME</code></td>
<td>操作系统名称</td>
</tr>
<tr>
<td><code>CMAKE_HOST_SYSTEM_NAME</code></td>
<td>主机系统名称</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(WIN32)</span><br><span class="line">  <span class="keyword">add_definitions</span>(-DPLATFORM_WINDOWS)</span><br><span class="line"><span class="keyword">elseif</span>(APPLE)</span><br><span class="line">  <span class="keyword">add_definitions</span>(-DPLATFORM_MAC)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-8-多平台编译器适配"><a href="#6-8-多平台编译器适配" class="headerlink" title="6.8 多平台编译器适配"></a>6.8 多平台编译器适配</h2><p>根据编译器设置选项：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(MSVC)</span><br><span class="line">  <span class="keyword">target_compile_options</span>(app PRIVATE /W4 /permissive-)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">  <span class="keyword">target_compile_options</span>(app PRIVATE -Wall -Wextra -pedantic)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>善用 <code>generator expressions</code> 区分快捷。</p>
<hr>
<h2 id="6-9-跨编译（Cross-Compilation）简述"><a href="#6-9-跨编译（Cross-Compilation）简述" class="headerlink" title="6.9 跨编译（Cross Compilation）简述"></a>6.9 跨编译（Cross Compilation）简述</h2><p>跨编译主要依靠“<strong>Toolchain 文件</strong>”：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_TOOLCHAIN_FILE=armgcc-toolchain.cmake -DCMAKE_BUILD_TYPE=Release ..</span><br></pre></td></tr></table></figure>

<p>示例 toolchain 文件：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_SYSTEM_NAME Linux)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_SYSTEM_PROCESSOR arm)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_C_COMPILER arm-linux-gnueabihf-gcc)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_COMPILER arm-linux-gnueabihf-g++)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_FIND_ROOT_PATH /opt/arm-sysroot)</span><br></pre></td></tr></table></figure>
<p>CMake 据此调整系统搜索路径与交叉工具链。  </p>
<hr>
<h2 id="6-10-默认输出目录按配置分类"><a href="#6-10-默认输出目录按配置分类" class="headerlink" title="6.10 默认输出目录按配置分类"></a>6.10 默认输出目录按配置分类</h2><p>推荐写法：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY <span class="string">&quot;$&#123;CMAKE_BINARY_DIR&#125;/bin&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_ARCHIVE_OUTPUT_DIRECTORY <span class="string">&quot;$&#123;CMAKE_BINARY_DIR&#125;/lib&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_LIBRARY_OUTPUT_DIRECTORY <span class="string">&quot;$&#123;CMAKE_BINARY_DIR&#125;/lib&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(OUTPUTCONFIG IN LISTS CMAKE_CONFIGURATION_TYPES)</span><br><span class="line">  <span class="keyword">string</span>(TOUPPER <span class="variable">$&#123;OUTPUTCONFIG&#125;</span> OUTPUTCONFIG)</span><br><span class="line">  <span class="keyword">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY_<span class="variable">$&#123;OUTPUTCONFIG&#125;</span> <span class="string">&quot;$&#123;CMAKE_BINARY_DIR&#125;/bin/$&#123;OUTPUTCONFIG&#125;&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(CMAKE_LIBRARY_OUTPUT_DIRECTORY_<span class="variable">$&#123;OUTPUTCONFIG&#125;</span> <span class="string">&quot;$&#123;CMAKE_BINARY_DIR&#125;/lib/$&#123;OUTPUTCONFIG&#125;&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(CMAKE_ARCHIVE_OUTPUT_DIRECTORY_<span class="variable">$&#123;OUTPUTCONFIG&#125;</span> <span class="string">&quot;$&#123;CMAKE_BINARY_DIR&#125;/lib/$&#123;OUTPUTCONFIG&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">endforeach</span>()</span><br></pre></td></tr></table></figure>
<p>这样 Debug&#x2F;Release 便会分目录保存。</p>
<hr>
<h2 id="6-11-多平台策略经验总结"><a href="#6-11-多平台策略经验总结" class="headerlink" title="6.11 多平台策略经验总结"></a>6.11 多平台策略经验总结</h2><p>1️⃣ <strong>不滥用 if(PLATFORM)</strong><br>尽量放入单独 cmake 模块文件。<br>例如 <code>platform/windows.cmake</code>、<code>platform/linux.cmake</code>。  </p>
<p>2️⃣ <em><em>使用 target_</em> 属性接口化</em>*<br>而非直接全局设置 CMAKE_CXX_FLAGS。  </p>
<p>3️⃣ <strong>确保跨编译工具链自洽</strong><br>不要在 toolchain 里硬编码 host 路径；保持干净的 sysroot。  </p>
<p>4️⃣ <strong>利用缓存变量区分环境</strong><br>如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_TOOLCHAIN_FILE=... -DPLATFORM_RPI=ON</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-12-章节小结"><a href="#6-12-章节小结" class="headerlink" title="6.12 章节小结"></a>6.12 章节小结</h2><p>✅ 本章你已经掌握：  </p>
<ul>
<li>单配置 vs 多配置 构建机制  </li>
<li><code>CMAKE_BUILD_TYPE</code> 的意义  </li>
<li>各个类型的优化与宏控制  </li>
<li>在 target 层使用 generator 表达式实现多配置差异  </li>
<li>用 toolchain 文件跨平台构建工程  </li>
<li>多平台编译器选项与输出目录规范</li>
</ul>
<hr>
<hr>
<h1 id="🔧-第-7-章-自定义命令-与-自定义目标：add-custom-command-add-custom-target"><a href="#🔧-第-7-章-自定义命令-与-自定义目标：add-custom-command-add-custom-target" class="headerlink" title="🔧 第 7 章 | 自定义命令 与 自定义目标：add_custom_command() &amp; add_custom_target()"></a>🔧 第 7 章 | 自定义命令 与 自定义目标：add_custom_command() &amp; add_custom_target()</h1><hr>
<h2 id="7-1-核心概念"><a href="#7-1-核心概念" class="headerlink" title="7.1 核心概念"></a>7.1 核心概念</h2><blockquote>
<p><strong>CMake 不只会编译代码</strong>，它同样能驱动各种外部命令、代码生成、打包、复制、清理等任务。<br>这就依赖于 <code>add_custom_command()</code> 和 <code>add_custom_target()</code>。  </p>
</blockquote>
<ul>
<li><strong><code>add_custom_command()</code></strong> → 定制生成规则（产生文件）  </li>
<li><strong><code>add_custom_target()</code></strong> → 定义独立目标（不一定生成文件）</li>
</ul>
<hr>
<h2 id="7-2-add-custom-command-生成型命令"><a href="#7-2-add-custom-command-生成型命令" class="headerlink" title="7.2 add_custom_command() 生成型命令"></a>7.2 add_custom_command() 生成型命令</h2><p>语法一（输出文件）：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">  OUTPUT  generated.cpp</span><br><span class="line">  <span class="keyword">COMMAND</span> python3 gen.py input.idl -o generated.cpp</span><br><span class="line">  DEPENDS input.idl gen.py</span><br><span class="line">  COMMENT <span class="string">&quot;生成代码文件 generated.cpp&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>OUTPUT</code></td>
<td>执行命令后生成的文件</td>
</tr>
<tr>
<td><code>COMMAND</code></td>
<td>具体执行的命令</td>
</tr>
<tr>
<td><code>DEPENDS</code></td>
<td>文件或目标依赖</td>
</tr>
<tr>
<td><code>WORKING_DIRECTORY</code></td>
<td>运行目录</td>
</tr>
<tr>
<td><code>COMMENT</code></td>
<td>日志显示</td>
</tr>
<tr>
<td><code>BYPRODUCTS</code></td>
<td>除 OUTPUT 外产生的其他文件</td>
</tr>
<tr>
<td><code>VERBATIM</code></td>
<td>自动安全转义字符串</td>
</tr>
</tbody></table>
<p>🔹 执行机制：当 CMake 发现 <code>OUTPUT</code> 缺失或 <code>DEPENDS</code> 更新时，该命令触发。</p>
<hr>
<h3 id="与-target-建立关系"><a href="#与-target-建立关系" class="headerlink" title="与 target 建立关系"></a>与 target 建立关系</h3><p>上面只是规则，要让它生效，必须让某目标依赖它：  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span>(app main.cpp generated.cpp)</span><br><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">  OUTPUT generated.cpp</span><br><span class="line">  <span class="keyword">COMMAND</span> python3 gen.py input.idl -o generated.cpp</span><br><span class="line">  DEPENDS input.idl gen.py</span><br><span class="line">  COMMENT <span class="string">&quot;生成接口文件&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>CMake 自动在编译 app 前执行代码生成。</p>
<p>若独立生成多个文件可组合：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">  OUTPUT a.h b.h</span><br><span class="line">  <span class="keyword">COMMAND</span> gen_headers.sh <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span></span><br><span class="line">  DEPENDS defs.json</span><br><span class="line">  BYPRODUCTS temp.log)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-3-add-custom-target-自定义目标"><a href="#7-3-add-custom-target-自定义目标" class="headerlink" title="7.3 add_custom_target() 自定义目标"></a>7.3 add_custom_target() 自定义目标</h2><p>语法：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_target</span>(&lt;name&gt; [ALL]</span><br><span class="line">  <span class="keyword">COMMAND</span> &lt;cmd1&gt; [ARGS...]</span><br><span class="line">  DEPENDS &lt;other_target(s)&gt; &lt;<span class="keyword">file</span>(s)&gt;</span><br><span class="line">  COMMENT <span class="string">&quot;some text&quot;</span>)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>ALL</code></td>
<td>编入默认 <code>all</code> 目标</td>
</tr>
<tr>
<td><code>COMMAND</code></td>
<td>可多条</td>
</tr>
<tr>
<td><code>DEPENDS</code></td>
<td>可是文件或目标</td>
</tr>
<tr>
<td><code>WORKING_DIRECTORY</code></td>
<td>执行位置</td>
</tr>
</tbody></table>
<p>例如：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_target</span>(run ALL</span><br><span class="line">  <span class="keyword">COMMAND</span> app</span><br><span class="line">  DEPENDS app</span><br><span class="line">  COMMENT <span class="string">&quot;执行应用程序&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>执行：<code>cmake --build . --target run</code></p>
<hr>
<h2 id="7-4-add-custom-target-VS-add-custom-command"><a href="#7-4-add-custom-target-VS-add-custom-command" class="headerlink" title="7.4 add_custom_target VS add_custom_command"></a>7.4 add_custom_target VS add_custom_command</h2><table>
<thead>
<tr>
<th>功能差异</th>
<th>add_custom_command</th>
<th>add_custom_target</th>
</tr>
</thead>
<tbody><tr>
<td>是否生成文件</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>能否依赖于目标</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>可否加入默认编译</td>
<td>否（需被其他目标依赖）</td>
<td>可选 ALL</td>
</tr>
<tr>
<td>常见用途</td>
<td>代码生成、资源拷贝等</td>
<td>运行脚本、测试、打包</td>
</tr>
</tbody></table>
<p>组合使用：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_command</span>(OUTPUT generated.h</span><br><span class="line">  <span class="keyword">COMMAND</span> gen_header tool.idl -o generated.h</span><br><span class="line">  DEPENDS tool.idl)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_custom_target</span>(generate ALL</span><br><span class="line">  DEPENDS generated.h)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-5-典型用途示例"><a href="#7-5-典型用途示例" class="headerlink" title="7.5 典型用途示例"></a>7.5 典型用途示例</h2><h3 id="1-资源拷贝"><a href="#1-资源拷贝" class="headerlink" title="(1) 资源拷贝"></a>(1) 资源拷贝</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">  <span class="keyword">TARGET</span> app POST_BUILD</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E copy</span><br><span class="line">          <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/config.json</span><br><span class="line">          $&lt;TARGET_FILE_DIR:app&gt;/config.json)</span><br></pre></td></tr></table></figure>

<p>💬 语法 2 ：当命令与已有目标关联时，可以省去 OUTPUT。</p>
<hr>
<h3 id="2-代码生成-→-Protobuf"><a href="#2-代码生成-→-Protobuf" class="headerlink" title="(2) 代码生成 → Protobuf"></a>(2) 代码生成 → Protobuf</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">  OUTPUT address.pb.cc address.pb.h</span><br><span class="line">  <span class="keyword">COMMAND</span> protoc --cpp_out=. <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/address.proto</span><br><span class="line">  DEPENDS <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/address.proto)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(proto address.pb.cc)</span><br><span class="line"><span class="keyword">target_include_directories</span>(proto PUBLIC <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-打包目标"><a href="#3-打包目标" class="headerlink" title="(3) 打包目标"></a>(3) 打包目标</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_target</span>(package_zip ALL</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E <span class="keyword">make_directory</span> <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/dist</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E tar <span class="string">&quot;cfv&quot;</span> dist/app.zip --format=zip</span><br><span class="line">          app.exe config.json</span><br><span class="line">  COMMENT <span class="string">&quot;打包项目&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-6-CMake-内置辅助命令"><a href="#7-6-CMake-内置辅助命令" class="headerlink" title="7.6 CMake 内置辅助命令"></a>7.6 CMake 内置辅助命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>cmake -E copy</code></td>
<td>复制文件</td>
</tr>
<tr>
<td><code>cmake -E remove</code></td>
<td>删除文件</td>
</tr>
<tr>
<td><code>cmake -E tar</code></td>
<td>打包&#x2F;解包</td>
</tr>
<tr>
<td><code>cmake -E echo</code></td>
<td>打印信息</td>
</tr>
<tr>
<td><code>cmake -E env</code></td>
<td>设置临时环境变量</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_target</span>(print_env</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E env MY_VAR=<span class="number">123</span> bash -c <span class="string">&quot;echo $MY_VAR&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-7-构建事件与阶段"><a href="#7-7-构建事件与阶段" class="headerlink" title="7.7 构建事件与阶段"></a>7.7 构建事件与阶段</h2><p>CMake 支持在目标的不同阶段插入命令：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">  <span class="keyword">TARGET</span> app</span><br><span class="line">  PRE_BUILD   <span class="keyword">COMMAND</span> &lt;cmd&gt;  <span class="comment"># Windows only</span></span><br><span class="line">  PRE_LINK    <span class="keyword">COMMAND</span> &lt;cmd&gt;</span><br><span class="line">  POST_BUILD  <span class="keyword">COMMAND</span> &lt;cmd&gt;)</span><br></pre></td></tr></table></figure>

<p>Linux 下通常使用 POST_BUILD 即可。</p>
<hr>
<h2 id="7-8-自定义清理与格式化"><a href="#7-8-自定义清理与格式化" class="headerlink" title="7.8 自定义清理与格式化"></a>7.8 自定义清理与格式化</h2><h3 id="清理生成文件："><a href="#清理生成文件：" class="headerlink" title="清理生成文件："></a>清理生成文件：</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_target</span>(clean_gen</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E rm -f generated.*</span><br><span class="line">  COMMENT <span class="string">&quot;清理生成的中间文件&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="一键格式化源代码："><a href="#一键格式化源代码：" class="headerlink" title="一键格式化源代码："></a>一键格式化源代码：</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_target</span>(format</span><br><span class="line">  <span class="keyword">COMMAND</span> clang-format -i <span class="variable">$&#123;ALL_SOURCE_FILES&#125;</span></span><br><span class="line">  COMMENT <span class="string">&quot;源代码格式化&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-9-综合实例：集成自动代码生成"><a href="#7-9-综合实例：集成自动代码生成" class="headerlink" title="7.9 综合实例：集成自动代码生成"></a>7.9 综合实例：集成自动代码生成</h2><p>目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tool/</span><br><span class="line">├─ gen.py</span><br><span class="line">├─ input.msg</span><br><span class="line">└─ main.cpp</span><br></pre></td></tr></table></figure>

<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_custom_command</span>(</span><br><span class="line">  OUTPUT <span class="keyword">message</span>.hpp</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;Python3_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/gen.py <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/input.msg &gt; <span class="keyword">message</span>.hpp</span><br><span class="line">  DEPENDS gen.py input.msg</span><br><span class="line">  COMMENT <span class="string">&quot;生成 message.hpp&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(tool main.cpp <span class="keyword">message</span>.hpp)</span><br></pre></td></tr></table></figure>

<p>执行构建时，如果输入有更新，CMake 会自动重新执行 gen.py。</p>
<hr>
<h2 id="7-10-章节小结"><a href="#7-10-章节小结" class="headerlink" title="7.10 章节小结"></a>7.10 章节小结</h2><p>✅ 你已掌握：</p>
<ul>
<li><code>add_custom_command()</code> 用于生成文件或附加命令  </li>
<li><code>add_custom_target()</code> 用于定义逻辑目标  </li>
<li>如何在 目标 不同阶段 执行命令（PRE&#x2F;POST_BUILD）  </li>
<li>利用 cmake 内置执行命令 <code>cmake -E</code> 完成通用任务  </li>
<li>自定义格式化、打包、清理、代码生成任务实践</li>
</ul>
<hr>
<hr>
<h1 id="🧪-第-8-章-测试与持续集成：CTest-与-CDash-使用"><a href="#🧪-第-8-章-测试与持续集成：CTest-与-CDash-使用" class="headerlink" title="🧪 第 8 章 | 测试与持续集成：CTest 与 CDash 使用"></a>🧪 第 8 章 | 测试与持续集成：CTest 与 CDash 使用</h1><hr>
<h2 id="8-1-CMake-与-CTest-的关系"><a href="#8-1-CMake-与-CTest-的关系" class="headerlink" title="8.1 CMake 与 CTest 的关系"></a>8.1 CMake 与 CTest 的关系</h2><p>CMake 并不仅生成构建系统，还包含自己的测试驱动框架 —— <strong>CTest</strong>。<br>它允许你在编译后自动执行单元测试、性能测试，并把结果提交给 CDash 仪表盘。  </p>
<blockquote>
<p>✅ 核心优势  </p>
<ul>
<li>跨平台测试入口一致：<code>ctest</code>  </li>
<li>可与 CTest 命令、CTestConfig.cmake、CDash 无缝集成  </li>
<li>同时支持 GoogleTest、Catch2、doctest 等框架</li>
</ul>
</blockquote>
<hr>
<h2 id="8-2-启用测试"><a href="#8-2-启用测试" class="headerlink" title="8.2 启用测试"></a>8.2 启用测试</h2><p>在顶层 CMakeLists.txt 内加入：  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enable_testing</span>()</span><br></pre></td></tr></table></figure>
<p>此命会自动生成 CTestTestfile.cmake，<br>并允许使用 <code>add_test()</code> 添加测试目标。  </p>
<hr>
<h2 id="8-3-add-test-基础语法"><a href="#8-3-add-test-基础语法" class="headerlink" title="8.3 add_test() 基础语法"></a>8.3 add_test() 基础语法</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(NAME &lt;test_name&gt;</span><br><span class="line">         <span class="keyword">COMMAND</span> &lt;executable&gt; [args...])</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span>(mytests test_main.cpp)</span><br><span class="line"><span class="keyword">add_test</span>(NAME basic <span class="keyword">COMMAND</span> mytests)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>之后即可在构建目录下运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctest</span><br><span class="line">ctest -V   <span class="comment"># verbose 输出</span></span><br><span class="line">ctest -R basic  <span class="comment"># 按名称筛选</span></span><br></pre></td></tr></table></figure>
</blockquote>
<hr>
<h2 id="8-4-test-属性与配置"><a href="#8-4-test-属性与配置" class="headerlink" title="8.4 test 属性与配置"></a>8.4 test 属性与配置</h2><table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>WORKING_DIRECTORY</td>
<td>更改测试执行目录</td>
</tr>
<tr>
<td>TIMEOUT</td>
<td>指定超时(秒)</td>
</tr>
<tr>
<td>ENVIRONMENT</td>
<td>设置环境变量</td>
</tr>
<tr>
<td>LABELS</td>
<td>添加标签分类</td>
</tr>
<tr>
<td>DEPENDS</td>
<td>依赖其他测试完成</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(NAME net_ping</span><br><span class="line">  <span class="keyword">COMMAND</span> ping_app --url=https://example.com)</span><br><span class="line"><span class="keyword">set_tests_properties</span>(net_ping PROPERTIES</span><br><span class="line">  TIMEOUT <span class="number">15</span></span><br><span class="line">  LABELS <span class="string">&quot;network;integration&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-5-与-GoogleTest-集成"><a href="#8-5-与-GoogleTest-集成" class="headerlink" title="8.5 与 GoogleTest 集成"></a>8.5 与 GoogleTest 集成</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(FetchContent)</span><br><span class="line">FetchContent_Declare(</span><br><span class="line">  googletest</span><br><span class="line">  GIT_REPOSITORY https://github.com/google/googletest.git</span><br><span class="line">  GIT_TAG release-<span class="number">1.14</span>.<span class="number">0</span>)</span><br><span class="line">FetchContent_MakeAvailable(googletest)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(unit_tests test_math.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(unit_tests PRIVATE GTest::gtest_main)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(GoogleTest)</span><br><span class="line">gtest_discover_tests(unit_tests)</span><br></pre></td></tr></table></figure>

<p>执行：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctest -V</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>gtest_discover_tests()</code> 会在配置时自动枚举 TEST() 宏生成的子测试。</p>
</blockquote>
<hr>
<h2 id="8-6-输出与日志"><a href="#8-6-输出与日志" class="headerlink" title="8.6 输出与日志"></a>8.6 输出与日志</h2><table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>-V</code></td>
<td>详细信息</td>
</tr>
<tr>
<td><code>-N</code></td>
<td>只列出而不执行</td>
</tr>
<tr>
<td><code>--output-on-failure</code></td>
<td>失败时输出详情</td>
</tr>
<tr>
<td><code>--repeat until-fail:3</code></td>
<td>重试失败测试</td>
</tr>
<tr>
<td><code>-R pattern</code></td>
<td>按名称正则筛选</td>
</tr>
</tbody></table>
<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctest --output-on-failure -R net</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-7-分组与标签管理"><a href="#8-7-分组与标签管理" class="headerlink" title="8.7 分组与标签管理"></a>8.7 分组与标签管理</h2><p>可通过标签控制测试集合：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set_tests_properties</span>(api_test PROPERTIES LABELS <span class="string">&quot;integration&quot;</span>)</span><br><span class="line"><span class="keyword">set_tests_properties</span>(math_test PROPERTIES LABELS <span class="string">&quot;unit&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>运行分组：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctest -L unit</span><br></pre></td></tr></table></figure>

<p>或排除：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctest -LE integration</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-8-CTest-配置文件"><a href="#8-8-CTest-配置文件" class="headerlink" title="8.8 CTest 配置文件"></a>8.8 CTest 配置文件</h2><p>在项目根目录创建 <code>CTestConfig.cmake</code>：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CTEST_PROJECT_NAME <span class="string">&quot;MyProj&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CTEST_NIGHTLY_START_TIME <span class="string">&quot;00:00:00 UTC&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CTEST_DROP_METHOD <span class="string">&quot;https&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CTEST_DROP_SITE <span class="string">&quot;cdash.myserver.com&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CTEST_DROP_LOCATION <span class="string">&quot;/submit.php?project=MyProj&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CTEST_DROP_SITE_CDASH <span class="keyword">TRUE</span>)</span><br></pre></td></tr></table></figure>

<p>该文件为 CDash 上传配置提供默认值。</p>
<hr>
<h2 id="8-9-CTest-驱动脚本模式"><a href="#8-9-CTest-驱动脚本模式" class="headerlink" title="8.9 CTest 驱动脚本模式"></a>8.9 CTest 驱动脚本模式</h2><blockquote>
<p>通过 <code>ctest -S script.cmake</code> 运行可自动完成：配置 → 编译 → 测试 → 上传。  </p>
</blockquote>
<p>示例 <code>script.cmake</code>：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ctest_start</span>(Experimental)</span><br><span class="line"><span class="keyword">ctest_configure</span>(BUILD <span class="string">&quot;$&#123;CMAKE_BINARY_DIR&#125;&quot;</span> SOURCE <span class="string">&quot;$&#123;CMAKE_SOURCE_DIR&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">ctest_build</span>()</span><br><span class="line"><span class="keyword">ctest_test</span>(REPORT_FORMAT xml OUTPUT_JUNIT results.xml)</span><br><span class="line"><span class="keyword">ctest_submit</span>()</span><br></pre></td></tr></table></figure>

<p>可配合 cron 或 CI&#x2F;CD 定期执行。</p>
<hr>
<h2 id="8-10-CDash-仪表盘简介"><a href="#8-10-CDash-仪表盘简介" class="headerlink" title="8.10 CDash 仪表盘简介"></a>8.10 CDash 仪表盘简介</h2><p><strong>CDash</strong> 是 Kitware 提供的 Web 测试结果展示平台。  </p>
<p>你可以：</p>
<ul>
<li>聚合各个构建机的 Build&#x2F;Test 结果</li>
<li>可视化性能&#x2F;覆盖率变化</li>
<li>追踪回归</li>
</ul>
<p>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8081:80 kitware/cdash</span><br></pre></td></tr></table></figure>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:8081/">http://localhost:8081</a><br>然后在 CTestConfig.cmake 中填写相应的 DROP 地址。</p>
<hr>
<h2 id="8-11-测试覆盖率与内存检查"><a href="#8-11-测试覆盖率与内存检查" class="headerlink" title="8.11 测试覆盖率与内存检查"></a>8.11 测试覆盖率与内存检查</h2><h3 id="覆盖率"><a href="#覆盖率" class="headerlink" title="覆盖率"></a>覆盖率</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -DENABLE_COVERAGE=ON ..</span><br><span class="line">make coverage</span><br></pre></td></tr></table></figure>
<p>结合工具如 <code>gcovr</code> &#x2F; <code>llvm-cov</code>。  </p>
<h3 id="内存泄漏检查"><a href="#内存泄漏检查" class="headerlink" title="内存泄漏检查"></a>内存泄漏检查</h3><p>在测试命令中加：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(NAME memcheck</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E env ASAN_OPTIONS=detect_leaks=<span class="number">1</span> ctest)</span><br></pre></td></tr></table></figure>
<p>或使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctest -T MemCheck</span><br></pre></td></tr></table></figure>
<p>CMake 会自动在测试下运行 Valgrind 或 Dr.Memory。</p>
<hr>
<h2 id="8-12-与-CI-系统结合"><a href="#8-12-与-CI-系统结合" class="headerlink" title="8.12 与 CI 系统结合"></a>8.12 与 CI 系统结合</h2><p>常见方式：<br>1️⃣ <strong>GitHub Actions</strong><br>   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">run:</span> <span class="string">cmake</span> <span class="string">-S</span> <span class="string">.</span> <span class="string">-B</span> <span class="string">build</span> <span class="string">-DCMAKE_BUILD_TYPE=Release</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">run:</span> <span class="string">cmake</span> <span class="string">--build</span> <span class="string">build</span> <span class="string">-j</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">run:</span> <span class="string">ctest</span> <span class="string">--test-dir</span> <span class="string">build</span> <span class="string">--output-on-failure</span></span><br></pre></td></tr></table></figure></p>
<p>2️⃣ <strong>GitLab CI</strong><br>   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cmake</span> <span class="string">-S</span> <span class="string">.</span> <span class="string">-B</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cmake</span> <span class="string">--build</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">build</span> <span class="string">&amp;&amp;</span> <span class="string">ctest</span> <span class="string">-V</span></span><br></pre></td></tr></table></figure></p>
<p>3️⃣ <strong>Jenkins &#x2F; TeamCity</strong></p>
<blockquote>
<p>可直接执行 ctest 或调用 CTest 脚本模式。  </p>
</blockquote>
<hr>
<h2 id="8-13-章节小结"><a href="#8-13-章节小结" class="headerlink" title="8.13 章节小结"></a>8.13 章节小结</h2><p>✅ 你现在会：</p>
<ul>
<li>使用 <code>enable_testing()</code> 启用测试  </li>
<li>借助 <code>add_test()</code> 添加单元测试  </li>
<li>输出详细日志并分组管理  </li>
<li>集成 GoogleTest 框架  </li>
<li>通过 CTest 脚本 + CDash 形成完整仪表盘  </li>
<li>将测试接入 CI&#x2F;CD 平台</li>
</ul>
<hr>
<hr>
<h1 id="📦-第-9-章-安装、导出与复用：install-与-CMake-Package-Config"><a href="#📦-第-9-章-安装、导出与复用：install-与-CMake-Package-Config" class="headerlink" title="📦 第 9 章 | 安装、导出与复用：install() 与 CMake Package Config"></a>📦 第 9 章 | 安装、导出与复用：install() 与 CMake Package Config</h1><hr>
<h2 id="9-1-安装的意义"><a href="#9-1-安装的意义" class="headerlink" title="9.1 安装的意义"></a>9.1 安装的意义</h2><p>CMake 可以将编译产物、头文件、配置、资源统一打包到安装目录。<br>这不仅方便部署，还能让别的项目通过 <code>find_package()</code> 直接复用你的库。  </p>
<p><strong>安装流程</strong>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --install &lt;build_dir&gt; [--prefix &lt;path&gt;]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>默认前缀为 <code>$&#123;CMAKE_INSTALL_PREFIX&#125;</code>，<br>Linux 通常 <code>/usr/local</code>，Windows 为 <code>C:/Program Files/&lt;proj&gt;</code>。</p>
</blockquote>
<hr>
<h2 id="9-2-install-核心语法"><a href="#9-2-install-核心语法" class="headerlink" title="9.2 install() 核心语法"></a>9.2 install() 核心语法</h2><p>CMake 的 <code>install()</code> 命令支持安装“目标”、“文件”、“目录”和“脚本”。  </p>
<table>
<thead>
<tr>
<th>类型</th>
<th>示例</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>TARGETS</td>
<td><code>install(TARGETS mylib)</code></td>
<td>可执行&#x2F;库目标</td>
</tr>
<tr>
<td>FILES</td>
<td><code>install(FILES a.h b.h DESTINATION include)</code></td>
<td>纯文件</td>
</tr>
<tr>
<td>DIRECTORY</td>
<td><code>install(DIRECTORY include/ DESTINATION include)</code></td>
<td>整个目录</td>
</tr>
<tr>
<td>PROGRAMS</td>
<td><code>install(PROGRAMS script.sh DESTINATION bin)</code></td>
<td>可执行脚本</td>
</tr>
<tr>
<td>SCRIPT &#x2F; CODE</td>
<td>用于在安装执行 CMake 代码</td>
<td></td>
</tr>
</tbody></table>
<hr>
<h2 id="9-3-安装可执行与库"><a href="#9-3-安装可执行与库" class="headerlink" title="9.3 安装可执行与库"></a>9.3 安装可执行与库</h2><p>最常见写法：  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span>(app main.cpp)</span><br><span class="line"><span class="keyword">add_library</span>(mathlib <span class="keyword">math</span>.cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">install</span>(TARGETS app mathlib</span><br><span class="line">  RUNTIME DESTINATION bin</span><br><span class="line">  LIBRARY DESTINATION lib</span><br><span class="line">  ARCHIVE DESTINATION lib/static)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>- RUNTIME → 可执行文件<br>- LIBRARY → 动态库 (.so&#x2F;.dylib)<br>- ARCHIVE → 静态库 (.a&#x2F;.lib)  </p>
</blockquote>
<hr>
<h2 id="9-4-安装头文件"><a href="#9-4-安装头文件" class="headerlink" title="9.4 安装头文件"></a>9.4 安装头文件</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(DIRECTORY <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>/</span><br><span class="line">  DESTINATION <span class="keyword">include</span></span><br><span class="line">  FILES_MATCHING PATTERN <span class="string">&quot;*.h&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>或直接列表式：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(FILES <span class="keyword">math</span>.h util.h DESTINATION <span class="keyword">include</span>/mylib)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-5-CMAKE-INSTALL-PREFIX-修改"><a href="#9-5-CMAKE-INSTALL-PREFIX-修改" class="headerlink" title="9.5 CMAKE_INSTALL_PREFIX 修改"></a>9.5 CMAKE_INSTALL_PREFIX 修改</h2><p>配置时指定：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -DCMAKE_INSTALL_PREFIX=/opt/mylib ..</span><br><span class="line">cmake --install build</span><br></pre></td></tr></table></figure>

<p>也可在 CMakeLists 中设置默认：  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_INSTALL_PREFIX <span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/dist&quot;</span> CACHE PATH <span class="string">&quot;&quot;</span> FORCE)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-6-生成安装包目录结构示例"><a href="#9-6-生成安装包目录结构示例" class="headerlink" title="9.6 生成安装包目录结构示例"></a>9.6 生成安装包目录结构示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dist/</span><br><span class="line"> ├─ bin/</span><br><span class="line"> │   └─ app</span><br><span class="line"> ├─ lib/</span><br><span class="line"> │   ├─ libmathlib.so</span><br><span class="line"> │   └─ cmake/mylib/MyLibConfig.cmake</span><br><span class="line"> ├─ include/</span><br><span class="line"> │   └─ mylib/</span><br><span class="line"> │       └─ math.h</span><br><span class="line"> └─ share/doc/</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-7-导出目标与重用"><a href="#9-7-导出目标与重用" class="headerlink" title="9.7 导出目标与重用"></a>9.7 导出目标与重用</h2><p>为了让别的项目 <code>find_package(MyLib)</code> 生效，<br>需要导出目标和配置文件。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(TARGETS mathlib</span><br><span class="line">  <span class="keyword">EXPORT</span> MyLibTargets</span><br><span class="line">  DESTINATION lib)</span><br><span class="line"></span><br><span class="line"><span class="keyword">install</span>(<span class="keyword">EXPORT</span> MyLibTargets</span><br><span class="line">  <span class="keyword">FILE</span> MyLibTargets.cmake</span><br><span class="line">  NAMESPACE MyLib::</span><br><span class="line">  DESTINATION lib/cmake/MyLib)</span><br></pre></td></tr></table></figure>

<p>这样别的项目可写：  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(MyLib REQUIRED)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE MyLib::mathlib)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-8-Config-Package-文件"><a href="#9-8-Config-Package-文件" class="headerlink" title="9.8 Config Package 文件"></a>9.8 Config Package 文件</h2><p>生成 <code>MyLibConfig.cmake</code> 和 <code>MyLibConfigVersion.cmake</code>，<br>用于描述库版本与依赖。&#96;&#96;&#96;cmake<br>include(CMakePackageConfigHelpers)</p>
<p>write_basic_package_version_file(<br>  “${CMAKE_CURRENT_BINARY_DIR}&#x2F;MyLibConfigVersion.cmake”<br>  VERSION ${PROJECT_VERSION}<br>  COMPATIBILITY SameMajorVersion)</p>
<p>configure_package_config_file(<br>  “${CMAKE_CURRENT_SOURCE_DIR}&#x2F;cmake&#x2F;MyLibConfig.cmake.in”<br>  “${CMAKE_CURRENT_BINARY_DIR}&#x2F;MyLibConfig.cmake”<br>  INSTALL_DESTINATION lib&#x2F;cmake&#x2F;MyLib)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">模板 `MyLibConfig.cmake.in`：</span><br><span class="line">```cmake</span><br><span class="line">@PACKAGE_INIT@</span><br><span class="line">include(&quot;$&#123;CMAKE_CURRENT_LIST_DIR&#125;/MyLibTargets.cmake&quot;)</span><br></pre></td></tr></table></figure>

<p>之后一起安装：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(FILES</span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyLibConfig.cmake&quot;</span></span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyLibConfigVersion.cmake&quot;</span></span><br><span class="line">  DESTINATION lib/cmake/MyLib)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-9-导出构建目录（非安装模式）"><a href="#9-9-导出构建目录（非安装模式）" class="headerlink" title="9.9 导出构建目录（非安装模式）"></a>9.9 导出构建目录（非安装模式）</h2><p>在开发时可直接导出构建树供临时使用：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span>(<span class="keyword">EXPORT</span> MyLibTargets</span><br><span class="line">  <span class="keyword">FILE</span> <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY&#125;/MyLibTargets.cmake&quot;</span></span><br><span class="line">  NAMESPACE MyLib::)</span><br></pre></td></tr></table></figure>

<p>别的项目在本地可通过：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(MyLib_DIR <span class="string">&quot;/path/to/build&quot;</span>)</span><br><span class="line"><span class="keyword">find_package</span>(MyLib REQUIRED)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-10-install-命令附带组件与条件"><a href="#9-10-install-命令附带组件与条件" class="headerlink" title="9.10 install 命令附带组件与条件"></a>9.10 install 命令附带组件与条件</h2><p>设置组件：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(TARGETS app</span><br><span class="line">  COMPONENT runtime</span><br><span class="line">  DESTINATION bin)</span><br><span class="line"><span class="keyword">install</span>(DIRECTORY docs/ DESTINATION share/doc COMPONENT doc)</span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --install build --component runtime</span><br></pre></td></tr></table></figure>

<p>条件安装：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(FILES config.win DESTINATION etc RENAME config.txt</span><br><span class="line">  CONFIGURATIONS Release)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-11-使用-CPack-生成打包文件"><a href="#9-11-使用-CPack-生成打包文件" class="headerlink" title="9.11 使用 CPack 生成打包文件"></a>9.11 使用 CPack 生成打包文件</h2><p>在项目中添加：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(InstallRequiredSystemLibraries)</span><br><span class="line"><span class="keyword">set</span>(CPACK_PACKAGE_NAME <span class="string">&quot;MyLib&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CPACK_PACKAGE_VERSION <span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CPACK_GENERATOR <span class="string">&quot;ZIP;TGZ&quot;</span>)</span><br><span class="line"><span class="keyword">include</span>(CPack)</span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpack</span><br></pre></td></tr></table></figure>
<p>将自动把安装产物打包为 zip &#x2F; tar.gz 文件。  </p>
<hr>
<h2 id="9-12-章节小结"><a href="#9-12-章节小结" class="headerlink" title="9.12 章节小结"></a>9.12 章节小结</h2><p>✅ 你已掌握：<br>- 使用 install() 安装目标、文件、目录<br>- 通过 CMAKE_INSTALL_PREFIX 控制安装路径<br>- 导出 Targets 与 Config 文件供其他项目复用<br>- 使用 CPack 生成跨平台安装包  </p>
<hr>
<hr>
<h1 id="🧩-第-10-章-进阶项目结构与模块化设计：分层、宏与函数、Find-Module-编写"><a href="#🧩-第-10-章-进阶项目结构与模块化设计：分层、宏与函数、Find-Module-编写" class="headerlink" title="🧩 第 10 章 | 进阶项目结构与模块化设计：分层、宏与函数、Find Module 编写"></a>🧩 第 10 章 | 进阶项目结构与模块化设计：分层、宏与函数、Find Module 编写</h1><hr>
<h2 id="10-1-大型项目的典型结构"><a href="#10-1-大型项目的典型结构" class="headerlink" title="10.1 大型项目的典型结构"></a>10.1 大型项目的典型结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MyProject/</span><br><span class="line">├─ CMakeLists.txt        # 顶层：配置、全局选项</span><br><span class="line">├─ cmake/                # 自定义模块脚本</span><br><span class="line">│   ├─ FindXXX.cmake</span><br><span class="line">│   └─ Utils.cmake</span><br><span class="line">├─ src/</span><br><span class="line">│   ├─ CMakeLists.txt    # 库 / 可执行定义</span><br><span class="line">│   ├─ core/</span><br><span class="line">│   └─ ui/</span><br><span class="line">├─ include/</span><br><span class="line">│   └─ myproj/</span><br><span class="line">│       └─ *.h</span><br><span class="line">├─ tests/</span><br><span class="line">│   ├─ CMakeLists.txt</span><br><span class="line">│   └─ *.cpp</span><br><span class="line">└─ examples/</span><br><span class="line">    └─ CMakeLists.txt</span><br></pre></td></tr></table></figure>

<p><strong>层级思路：</strong></p>
<ol>
<li>顶层处理全局配置、选项、依赖；</li>
<li>下层模块通过 <code>add_library()</code> 或 <code>add_executable()</code> 定义；</li>
<li>使用 <code>option()</code> 控制可编译模块；</li>
<li>代码与头文件保持分离。</li>
</ol>
<hr>
<h2 id="10-2-层级-CMakeLists-txt-的协作"><a href="#10-2-层级-CMakeLists-txt-的协作" class="headerlink" title="10.2 层级 CMakeLists.txt 的协作"></a>10.2 层级 CMakeLists.txt 的协作</h2><p>每级在自己的 CMakeLists.txt 中定义局部逻辑，<br>然后在上层用 <code>add_subdirectory()</code> 加载。</p>
<p><strong>顶层示例：</strong></p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.20</span>)</span><br><span class="line"><span class="keyword">project</span>(MyProject VERSION <span class="number">1.0</span> LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span>(ENABLE_TESTS <span class="string">&quot;Build tests&quot;</span> <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"><span class="keyword">if</span>(ENABLE_TESTS)</span><br><span class="line">  <span class="keyword">enable_testing</span>()</span><br><span class="line"> _subdirectory(tests)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(cmake/Utils.cmake)</span><br></pre></td></tr></table></figure>

<p><strong>子模块：</strong>  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(core core.cpp core.h)</span><br><span class="line"><span class="keyword">target_include_directories</span>(core PUBLIC <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-3-模块化与接口封装"><a href="#10-3-模块化与接口封装" class="headerlink" title="10.3 模块化与接口封装"></a>10.3 模块化与接口封装</h2><p>推荐做法：<br>每个子模块构成自成体系的 library，<br>暴露目标名、包含路径、依赖。  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(ui ui.cpp ui.h)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(ui PUBLIC core Qt::Widgets)</span><br></pre></td></tr></table></figure>

<p>其他模块只需：  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE ui)</span><br></pre></td></tr></table></figure>

<p>通过 <code>target_*</code> 接口管理依赖而非手工 include&#x2F;link，是现代 CMake 的关键。</p>
<hr>
<h2 id="10-4-自定义函数与宏"><a href="#10-4-自定义函数与宏" class="headerlink" title="10.4 自定义函数与宏"></a>10.4 自定义函数与宏</h2><p>CMake 支持 <code>function()</code> 与 <code>macro()</code> 定义可重用逻辑。  </p>
<table>
<thead>
<tr>
<th>区别</th>
<th>function</th>
<th>macro</th>
</tr>
</thead>
<tbody><tr>
<td>作用域</td>
<td>局部作用域（推荐）</td>
<td>扩展到调用处作用域</td>
</tr>
<tr>
<td>参数传递</td>
<td>复制</td>
<td>文本替换</td>
</tr>
</tbody></table>
<p>例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmake/Utils.cmake</span></span><br><span class="line"><span class="keyword">function</span>(add_my_exec name)</span><br><span class="line">  <span class="keyword">add_executable</span>(<span class="variable">$&#123;name&#125;</span> <span class="variable">$&#123;ARGN&#125;</span>)</span><br><span class="line">  <span class="keyword">target_compile_features</span>(<span class="variable">$&#123;name&#125;</span> PRIVATE cxx_std_17)</span><br><span class="line"><span class="keyword">endfunction</span>()</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(cmake/Utils.cmake)</span><br><span class="line">add_my_exec(app main.cpp)</span><br></pre></td></tr></table></figure>

<p>可简化重复模式并保持一致性。</p>
<hr>
<h2 id="10-5-跨子项目传递变量"><a href="#10-5-跨子项目传递变量" class="headerlink" title="10.5 跨子项目传递变量"></a>10.5 跨子项目传递变量</h2><p>若要在顶层控制子项目，可以利用 <code>CACHE</code> 变量或 <code>option()</code>。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(BUILD_UI <span class="keyword">ON</span> CACHE BOOL <span class="string">&quot;Build UI module&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>子项目就能检测 <code>BUILD_UI</code> 是否为 ON。</p>
<p>若想真正导出到其他 scope，可用：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(VAR_NAME value PARENT_SCOPE)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-6-自定义模块路径"><a href="#10-6-自定义模块路径" class="headerlink" title="10.6 自定义模块路径"></a>10.6 自定义模块路径</h2><p>若想让 CMake 找到自定义的 FindXXX.cmake：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">list</span>(APPEND CMAKE_MODULE_PATH <span class="string">&quot;$&#123;CMAKE_SOURCE_DIR&#125;/cmake&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这样执行 <code>find_package(XXX REQUIRED)</code> 时，会优先在该目录搜索。</p>
<hr>
<h2 id="10-7-Find-Module-文件结构"><a href="#10-7-Find-Module-文件结构" class="headerlink" title="10.7 Find Module 文件结构"></a>10.7 Find Module 文件结构</h2><p>Find 模块通常命名为 <strong>Find<Package>.cmake</strong>。<br>基本模板：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FindFoo.cmake</span></span><br><span class="line"><span class="keyword">find_path</span>(FOO_INCLUDE_DIR foo.h)</span><br><span class="line"><span class="keyword">find_library</span>(FOO_LIBRARY NAMES foo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(FindPackageHandleStandardArgs)</span><br><span class="line">find_package_handle_standard_args(Foo</span><br><span class="line">  REQUIRED_VARSOO_LIBRARY FOO_INCLUDE_DIR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(FOO_FOUND)</span><br><span class="line">  <span class="keyword">set</span>(FOO_LIBRARIES <span class="variable">$&#123;FOO_LIBRARY&#125;</span>)</span><br><span class="line">  <span class="keyword">set</span>(FOO_INCLUDE_DIRS <span class="variable">$&#123;FOO_INCLUDE_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>项目中即可：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Foo REQUIRED)</span><br><span class="line"><span class="keyword">target_include_directories</span>(app PRIVATE <span class="variable">$&#123;FOO_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE <span class="variable">$&#123;FOO_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-8-封装外部依赖"><a href="#10-8-封装外部依赖" class="headerlink" title="10.8 封装外部依赖"></a>10.8 封装外部依赖</h2><p>对于常见第三方库，例如 fmt、spdlog、OpenCV、Boost：  </p>
<ul>
<li><strong>优先使用官方 CMake 包</strong>  <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(fmt CONFIG REQUIRED)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE fmt::fmt)</span><br></pre></td></tr></table></figure></li>
<li><strong>无官方包时使用 Find 模块</strong>  </li>
<li><strong>或者使用 FetchContent 直接嵌入源码</strong></li>
</ul>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(FetchContent)</span><br><span class="line">FetchContent_Declare(spdlog</span><br><span class="line">  GIT_REPOSITORY https://github.com/gabime/spdlog.git</span><br><span class="line">  GIT_TAG v1.<span class="number">13.0</span>)</span><br><span class="line">FetchContent_MakeAvailable(spdlog)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE spdlog::spdlog)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="10-9-条件编译与平台差异"><a href="#10-9-条件编译与平台差异" class="headerlink" title="10.9 条件编译与平台差异"></a>10.9 条件编译与平台差异</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(WIN32)</span><br><span class="line">  <span class="keyword">target_compile_definitions</span>(app PRIVATE PLATFORM_WINDOWS)</span><br><span class="line"><span class="keyword">elseif</span>(APPLE)</span><br><span class="line">  <span class="keyword">target_compile_definitions</span>(app PRIVATE PLATFORM_MACOS)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">  <span class="keyword">target_compile_definitions</span>(app PRIVATE PLATFORM_LINUX)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>- <code>WIN32</code>, <code>UNIX</code>, <code>APPLE</code>, <code>CMAKE_SYSTEM_NAME</code> 等变量用于判断系统；<br>- 可配合 generator expression 在编译时自动切换。</p>
<hr>
<h2 id="10-10-生成器表达式回顾"><a href="#10-10-生成器表达式回顾" class="headerlink" title="10.10 生成器表达式回顾"></a>10.10 生成器表达式回顾</h2><p><strong>生成器表达式</strong> <code>$&lt;...&gt;</code><br>可在配置时决定某个属性在不同条件下的值：  </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_compile_definitions</span>(app PRIVATE</span><br><span class="line">  $&lt;$&lt;CONFIG:Debug&gt;:DEBUG_BUILD&gt;)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(app PRIVATE</span><br><span class="line">  $&lt;$&lt;PLATFORM_ID:Windows&gt;:ws2_32&gt;)</span><br></pre></td></tr></table></figure>

<p>这样统一管理多平台差异且保持文件整洁。</p>
<hr>
<h2 id="10-11-最佳实践总结"><a href="#10-11-最佳实践总结" class="headerlink" title="10.11 最佳实践总结"></a>10.11 最佳实践总结</h2><p>✅ <strong>模块原则</strong>  </p>
<ul>
<li>每个模块尽量独立（自定义头、源码、CMakeLists）  </li>
<li>在接口上暴露目标而非路径  </li>
<li>避免使用全局变量与全局 include_directories</li>
</ul>
<p>✅ <strong>函数封装</strong>  </p>
<ul>
<li>将重复规则抽象成函数  </li>
<li>尽量避免宏污染全局</li>
</ul>
<p>✅ <strong>依赖管理</strong>  </p>
<ul>
<li>优先 CONFIG 包 → Find 模块 → FetchContent  </li>
<li>自己的库要导出 Config 文件方便他人 find_package()</li>
</ul>
<p>✅ <strong>目录组织</strong>  </p>
<ul>
<li><code>cmake/</code> 放自定义脚本  </li>
<li><code>include/</code> 暴露头文件  </li>
<li><code>src/</code> 放实现  </li>
<li><code>tests/</code>、<code>examples/</code> 清晰分层</li>
</ul>
<hr>
<h2 id="10-12-整门课程回顾-🙌"><a href="#10-12-整门课程回顾-🙌" class="headerlink" title="10.12 整门课程回顾 🙌"></a>10.12 整门课程回顾 🙌</h2><table>
<thead>
<tr>
<th>章节</th>
<th>核心内容</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>CMake 初体验</td>
</tr>
<tr>
<td>2</td>
<td>基本命令与变量</td>
</tr>
<tr>
<td>3</td>
<td>目标与依赖管理</td>
</tr>
<tr>
<td>4</td>
<td>编译选项与特性控制</td>
</tr>
<tr>
<td>5</td>
<td>条件、循环与宏</td>
</tr>
<tr>
<td>6</td>
<td>外部项目与 FetchContent</td>
</tr>
<tr>
<td>7</td>
<td>自定义命令与目标</td>
</tr>
<tr>
<td>8</td>
<td>测试与 CTest&#x2F;CDash</td>
</tr>
<tr>
<td>9</td>
<td>安装与导出配置</td>
</tr>
<tr>
<td>10</td>
<td>模块化与大型工程架构</td>
</tr>
</tbody></table>
<p>🎯 现在你能从零设计、构建、测试、安装并复用跨平台 CMake 项目。  </p>
<hr>
<hr>
<h1 id="📘-附录-CMake-常用命令、变量与生成表达式速查表"><a href="#📘-附录-CMake-常用命令、变量与生成表达式速查表" class="headerlink" title="📘 附录 | CMake 常用命令、变量与生成表达式速查表"></a>📘 附录 | CMake 常用命令、变量与生成表达式速查表</h1><hr>
<h2 id="🔧-A-1-核心命令速查"><a href="#🔧-A-1-核心命令速查" class="headerlink" title="🔧 A.1 核心命令速查"></a>🔧 A.1 核心命令速查</h2><table>
<thead>
<tr>
<th>类别</th>
<th>常用命令</th>
<th>功能概述</th>
</tr>
</thead>
<tbody><tr>
<td><strong>项目初始化</strong></td>
<td><code>cmake_minimum_required()</code></td>
<td>声明所需最低版本</td>
</tr>
<tr>
<td></td>
<td><code>project(&lt;name&gt; VERSION &lt;v&gt; LANGUAGES C CXX)</code></td>
<td>定义项目名称与语言</td>
</tr>
<tr>
<td><strong>构建逻辑</strong></td>
<td><code>add_executable()</code></td>
<td>定义可执行文件</td>
</tr>
<tr>
<td></td>
<td><code>add_library()</code></td>
<td>定义静态或动态库</td>
</tr>
<tr>
<td></td>
<td><code>target_link_libraries()</code></td>
<td>绑定依赖目标</td>
</tr>
<tr>
<td></td>
<td><code>target_include_directories()</code></td>
<td>设置头文件路径</td>
</tr>
<tr>
<td></td>
<td><code>target_compile_definitions()</code></td>
<td>指定宏定义</td>
</tr>
<tr>
<td><strong>变量与选项</strong></td>
<td><code>set()</code></td>
<td>定义变量</td>
</tr>
<tr>
<td></td>
<td><code>option()</code></td>
<td>定义开关</td>
</tr>
<tr>
<td></td>
<td><code>message()</code></td>
<td>输出信息</td>
</tr>
<tr>
<td><strong>目录层级</strong></td>
<td><code>add_subdirectory()</code></td>
<td>包含子目录</td>
</tr>
<tr>
<td></td>
<td><code>include()</code></td>
<td>引入脚本文件</td>
</tr>
<tr>
<td><strong>条件与循环</strong></td>
<td><code>if()/elseif()/else()/endif()</code></td>
<td>条件判断</td>
</tr>
<tr>
<td></td>
<td><code>foreach()/endforeach()</code></td>
<td>循环迭代</td>
</tr>
<tr>
<td></td>
<td><code>while()/endwhile()</code></td>
<td>条件循环</td>
</tr>
<tr>
<td><strong>安装与打包</strong></td>
<td><code>install()</code></td>
<td>安装文件&#x2F;目标</td>
</tr>
<tr>
<td></td>
<td><code>include(CPack)</code></td>
<td>启动打包系统</td>
</tr>
<tr>
<td><strong>测试</strong></td>
<td><code>enable_testing()</code></td>
<td>开启测试功能</td>
</tr>
<tr>
<td></td>
<td><code>add_test()</code></td>
<td>注册测试</td>
</tr>
<tr>
<td></td>
<td><code>ctest</code></td>
<td>命令行执行测试</td>
</tr>
<tr>
<td><strong>自定义行为</strong></td>
<td><code>add_custom_command()</code></td>
<td>自定义命令</td>
</tr>
<tr>
<td></td>
<td><code>add_custom_target()</code></td>
<td>自定义目标</td>
</tr>
<tr>
<td><strong>导入与依赖</strong></td>
<td><code>find_package()</code></td>
<td>查找外部库</td>
</tr>
<tr>
<td></td>
<td><code>find_library()</code> &#x2F; <code>find_path()</code></td>
<td>查找文件或库路径</td>
</tr>
<tr>
<td><strong>脚本与函数</strong></td>
<td><code>function()</code></td>
<td>定义局部函数</td>
</tr>
<tr>
<td></td>
<td><code>macro()</code></td>
<td>定义宏</td>
</tr>
<tr>
<td><strong>导出复用</strong></td>
<td><code>install(EXPORT …)</code></td>
<td>安装导出目标</td>
</tr>
<tr>
<td></td>
<td><code>export(EXPORT …)</code></td>
<td>导出构建内目标</td>
</tr>
</tbody></table>
<hr>
<h2 id="🧩-A-2-重要变量速查"><a href="#🧩-A-2-重要变量速查" class="headerlink" title="🧩 A.2 重要变量速查"></a>🧩 A.2 重要变量速查</h2><table>
<thead>
<tr>
<th>变量</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>CMAKE_SOURCE_DIR</code></td>
<td>顶层源目录</td>
</tr>
<tr>
<td><code>CMAKE_BINARY_DIR</code></td>
<td>顶层构建目录</td>
</tr>
<tr>
<td><code>CMAKE_CURRENT_SOURCE_DIR</code></td>
<td>当前脚本源目录</td>
</tr>
<tr>
<td><code>CMAKE_CURRENT_BINARY_DIR</code></td>
<td>当前脚本构建目录</td>
</tr>
<tr>
<td><code>CMAKE_INSTALL_PREFIX</code></td>
<td>安装路径</td>
</tr>
<tr>
<td><code>CMAKE_BUILD_TYPE</code></td>
<td>构建类型（Debug&#x2F;Release）</td>
</tr>
<tr>
<td><code>PROJECT_SOURCE_DIR</code> &#x2F; <code>PROJECT_BINARY_DIR</code></td>
<td>当前项目路径</td>
</tr>
<tr>
<td><code>CMAKE_CXX_STANDARD</code></td>
<td>设置 C++ 标准版本</td>
</tr>
<tr>
<td><code>CMAKE_MODULE_PATH</code></td>
<td>查找自定义模块路径</td>
</tr>
<tr>
<td><code>CMAKE_PREFIX_PATH</code></td>
<td>提示 find_package() 查找前缀</td>
</tr>
<tr>
<td><code>CMAKE_TOOLCHAIN_FILE</code></td>
<td>指定交叉编译工具链文件</td>
</tr>
<tr>
<td><code>CMAKE_GENERATOR</code></td>
<td>当前生成器类型</td>
</tr>
<tr>
<td><code>CMAKE_EXPORT_COMPILE_COMMANDS</code></td>
<td>输出 compile_commands.json</td>
</tr>
</tbody></table>
<hr>
<h2 id="⚙️-A-3-常用生成表达式（Generator-Expressions）"><a href="#⚙️-A-3-常用生成表达式（Generator-Expressions）" class="headerlink" title="⚙️ A.3 常用生成表达式（Generator Expressions）"></a>⚙️ A.3 常用生成表达式（Generator Expressions）</h2><table>
<thead>
<tr>
<th>表达式</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>$&lt;CONFIG:Debug&gt;</code></td>
<td>在 Debug 配置时为真</td>
</tr>
<tr>
<td><code>$&lt;STREQUAL:a,b&gt;</code></td>
<td>判断字符串相等</td>
</tr>
<tr>
<td><code>$&lt;PLATFORM_ID:Windows&gt;</code></td>
<td>匹配特定平台</td>
</tr>
<tr>
<td><code>$&lt;COMPILE_LANG_AND_ID:CXX,Clang&gt;</code></td>
<td>检测编译器</td>
</tr>
<tr>
<td><code>$&lt;TARGET_EXISTS:foo&gt;</code></td>
<td>判断目标是否存在</td>
</tr>
<tr>
<td><code>$&lt;BUILD_INTERFACE:…&gt;</code></td>
<td>构建阶段有效内容</td>
</tr>
<tr>
<td><code>$&lt;INSTALL_INTERFACE:…&gt;</code></td>
<td>安装阶段有效内容</td>
</tr>
<tr>
<td><code>$&lt;BOOL:var&gt;</code></td>
<td>布尔取值</td>
</tr>
<tr>
<td><code>$&lt;IF:cond,then,else&gt;</code></td>
<td>条件表达式</td>
</tr>
<tr>
<td><code>$&lt;AND:cond1,cond2&gt;</code></td>
<td>与逻辑</td>
</tr>
<tr>
<td><code>$&lt;OR:cond1,cond2&gt;</code></td>
<td>或逻辑</td>
</tr>
</tbody></table>
<p>常见用法：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_include_directories</span>(mylib PUBLIC</span><br><span class="line">  $&lt;BUILD_INTERFACE:<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>&gt;</span><br><span class="line">  $&lt;INSTALL_INTERFACE:<span class="keyword">include</span>&gt;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🧰-A-4-CTest-命令速查"><a href="#🧰-A-4-CTest-命令速查" class="headerlink" title="🧰 A.4 CTest 命令速查"></a>🧰 A.4 CTest 命令速查</h2><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>ctest -N</code></td>
<td>仅列出测试</td>
</tr>
<tr>
<td><code>ctest -V</code></td>
<td>详细模式</td>
</tr>
<tr>
<td><code>ctest -R &lt;regex&gt;</code></td>
<td>按名称筛选</td>
</tr>
<tr>
<td><code>ctest --output-on-failure</code></td>
<td>仅输出失败测试信息</td>
</tr>
<tr>
<td><code>ctest -L &lt;label&gt;</code></td>
<td>按标签执行</td>
</tr>
<tr>
<td><code>ctest -T memcheck</code></td>
<td>运行内存检查</td>
</tr>
<tr>
<td><code>ctest -T coverage</code></td>
<td>运行覆盖率测试</td>
</tr>
<tr>
<td><code>ctest -S &lt;script&gt;</code></td>
<td>运行脚本模式</td>
</tr>
</tbody></table>
<hr>
<h2 id="🪣-A-5-目录组织风格与命名建议"><a href="#🪣-A-5-目录组织风格与命名建议" class="headerlink" title="🪣 A.5 目录组织风格与命名建议"></a>🪣 A.5 目录组织风格与命名建议</h2><table>
<thead>
<tr>
<th>项目部分</th>
<th>示例</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>主代码</td>
<td><code>src/</code></td>
<td>按模块细分：core、ui、net</td>
</tr>
<tr>
<td>头文件</td>
<td><code>include/&lt;project&gt;/</code></td>
<td>对外接口</td>
</tr>
<tr>
<td>单元测试</td>
<td><code>tests/</code></td>
<td>一致的命名：<code>test_*.cpp</code></td>
</tr>
<tr>
<td>示例</td>
<td><code>examples/</code></td>
<td>教学或验证代码</td>
</tr>
<tr>
<td>CMake 脚本</td>
<td><code>cmake/</code></td>
<td>存放 Find 模块 &#x2F; 工具函数</td>
</tr>
<tr>
<td>输出目录</td>
<td><code>build/</code></td>
<td>源码外构建</td>
</tr>
<tr>
<td>安装产物</td>
<td><code>dist/</code> 或 <code>install/</code></td>
<td>发布包</td>
</tr>
</tbody></table>
<hr>
<h2 id="📜-A-6-实用技巧汇总"><a href="#📜-A-6-实用技巧汇总" class="headerlink" title="📜 A.6 实用技巧汇总"></a>📜 A.6 实用技巧汇总</h2><ul>
<li>使用 <code>target_*</code> 系列代替全局命令；</li>
<li>自动检测编译器支持：<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(CheckCXXCompilerFlag)</span><br><span class="line">check_cxx_compiler_flag(<span class="string">&quot;-std=c++20&quot;</span> HAS_CXX20)</span><br></pre></td></tr></table></figure></li>
<li>通过 <code>FetchContent</code> 管理轻量依赖；</li>
<li>使用 <code>find_package(... CONFIG REQUIRED)</code> 优先导入现代 CMake 包；</li>
<li>在多平台脚本中利用生成表达式控制差异；</li>
<li>构建型导出与安装型导出结合，提高复用性；</li>
<li>确保项目最顶层 <code>CMakeLists.txt</code> 干净简明，可作为示例教学；</li>
<li>采用 <code>ctest</code> 持续测试和 CDash 可视化结果。</li>
</ul>
<hr>
<h2 id="🧭-A-7-参考与后续学习路线"><a href="#🧭-A-7-参考与后续学习路线" class="headerlink" title="🧭 A.7 参考与后续学习路线"></a>🧭 A.7 参考与后续学习路线</h2><table>
<thead>
<tr>
<th>主题</th>
<th>推荐资源</th>
</tr>
</thead>
<tbody><tr>
<td>官方文档</td>
<td><a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest">https://cmake.org/cmake/help/latest</a></td>
</tr>
<tr>
<td>Kitware Blog</td>
<td>深入讲解现代 CMake 特性与实践</td>
</tr>
<tr>
<td>“Effective Modern CMake”（开源电子书）</td>
<td>系统整理现代用法</td>
</tr>
<tr>
<td>GoogleTest &#x2F; Catch2 集成</td>
<td>官方示例仓库</td>
</tr>
<tr>
<td>Conan &#x2F; vcpkg</td>
<td>构建与打包生态工具</td>
</tr>
</tbody></table>
<hr>
<h2 id="🎓-结语"><a href="#🎓-结语" class="headerlink" title="🎓 结语"></a>🎓 结语</h2><p>你已经完整掌握从基础到进阶的 CMake 工程技巧：<br>从 <strong>构建系统生成 → 模块化依赖管理 → 测试 → 安装打包 → 复用与发布</strong>。  </p>
<p>无论是小型开源库还是企业级跨平台项目，<br>这套体系都能直接应用。  </p>
<hr>
<p>✅ <strong>学习完结</strong></p>
<blockquote>
<p>恭喜完成《现代 CMake 开发与工程实践指南》🎉<br>可以自行创建项目、维护模块库和集成 CI&#x2F;CD 测试！</p>
</blockquote>
<hr>
<hr>
<h1 id="🏗️-CMake-项目脚手架模板"><a href="#🏗️-CMake-项目脚手架模板" class="headerlink" title="🏗️ CMake 项目脚手架模板"></a>🏗️ CMake 项目脚手架模板</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MyProject/                # 项目根目录</span><br><span class="line">├─ CMakeLists.txt         # 顶层配置</span><br><span class="line">├─ include/</span><br><span class="line">│   └─ myproject/</span><br><span class="line">│       └─ myproject.h</span><br><span class="line">├─ src/</span><br><span class="line">│   ├─ CMakeLists.txt</span><br><span class="line">│   └─ myproject.cpp</span><br><span class="line">├─ tests/</span><br><span class="line">│   ├─ CMakeLists.txt</span><br><span class="line">│   └─ test_main.cpp</span><br><span class="line">├─ cmake/</span><br><span class="line">│   └─ Utils.cmake        # 工具模块示例</span><br><span class="line">└─ README.md</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🧩-顶层-CMakeLists-txt"><a href="#🧩-顶层-CMakeLists-txt" class="headerlink" title="🧩 顶层 CMakeLists.txt"></a>🧩 顶层 CMakeLists.txt</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.20</span>)</span><br><span class="line"><span class="keyword">project</span>(MyProject VERSION <span class="number">1.0</span>.<span class="number">0</span> LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1️⃣ 全局设置</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">17</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_EXTENSIONS <span class="keyword">OFF</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_EXPORT_COMPILE_COMMANDS <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span>(ENABLE_TESTS <span class="string">&quot;Build and run unit tests&quot;</span> <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">list</span>(APPEND CMAKE_MODULE_PATH <span class="string">&quot;$&#123;CMAKE_SOURCE_DIR&#125;/cmake&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2️⃣ 子目录</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"><span class="keyword">if</span>(ENABLE_TESTS)</span><br><span class="line">  <span class="keyword">enable_testing</span>()</span><br><span class="line">  <span class="keyword">add_subdirectory</span>(tests)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3️⃣ 安装导出配置（可选）</span></span><br><span class="line"><span class="keyword">include</span>(CMakePackageConfigHelpers)</span><br><span class="line"><span class="keyword">install</span>(TARGETS myproject</span><br><span class="line">  <span class="keyword">EXPORT</span> MyProjectTargets</span><br><span class="line">  ARCHIVE DESTINATION lib</span><br><span class="line">  LIBRARY DESTINATION lib</span><br><span class="line">  RUNTIME DESTINATION bin)</span><br><span class="line"><span class="keyword">install</span>(DIRECTORY <span class="keyword">include</span>/ DESTINATION <span class="keyword">include</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">install</span>(<span class="keyword">EXPORT</span> MyProjectTargets</span><br><span class="line">  <span class="keyword">FILE</span> MyProjectTargets.cmake</span><br><span class="line">  NAMESPACE MyProject::</span><br><span class="line">  DESTINATION lib/cmake/MyProject)</span><br><span class="line"></span><br><span class="line">configure_package_config_file(</span><br><span class="line">  cmake/MyProjectConfig.cmake.in</span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjectConfig.cmake&quot;</span></span><br><span class="line">  INSTALL_DESTINATION lib/cmake/MyProject)</span><br><span class="line"></span><br><span class="line">write_basic_package_version_file(</span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjectConfigVersion.cmake&quot;</span></span><br><span class="line">  VERSION <span class="variable">$&#123;PROJECT_VERSION&#125;</span></span><br><span class="line">  COMPATIBILITY SameMajorVersion)</span><br><span class="line"></span><br><span class="line"><span class="keyword">install</span>(FILES</span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjectConfig.cmake&quot;</span></span><br><span class="line">  <span class="string">&quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/MyProjectConfigVersion.cmake&quot;</span></span><br><span class="line">  DESTINATION lib/cmake/MyProject)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4️⃣ CPack 打包</span></span><br><span class="line"><span class="keyword">set</span>(CPACK_PACKAGE_VENDOR <span class="string">&quot;YourName&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CPACK_PACKAGE_CONTACT <span class="string">&quot;you@example.com&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CPACK_PACKAGE_FILE_NAME <span class="string">&quot;$&#123;PROJECT_NAME&#125;-$&#123;PROJECT_VERSION&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">include</span>(CPack)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="⚙️-src-CMakeLists-txt"><a href="#⚙️-src-CMakeLists-txt" class="headerlink" title="⚙️ src&#x2F;CMakeLists.txt"></a>⚙️ src&#x2F;CMakeLists.txt</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_library</span>(myproject myproject.cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_include_directories</span>(myproject</span><br><span class="line">  PUBLIC</span><br><span class="line">    $&lt;BUILD_INTERFACE:<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>&gt;</span><br><span class="line">    $&lt;INSTALL_INTERFACE:<span class="keyword">include</span>&gt;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_compile_features</span>(myproject PUBLIC cxx_std_17)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数（演示）：</span></span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/cmake/Utils.cmake)</span><br><span class="line">add_my_compile_options(myproject)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="✨-cmake-Utils-cmake"><a href="#✨-cmake-Utils-cmake" class="headerlink" title="✨ cmake&#x2F;Utils.cmake"></a>✨ cmake&#x2F;Utils.cmake</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>(add_my_compile_options <span class="keyword">target</span>)</span><br><span class="line">  <span class="keyword">message</span>(STATUS <span class="string">&quot;Applying default warnings to target $&#123;target&#125;&quot;</span>)</span><br><span class="line">  <span class="keyword">target_compile_options</span>(<span class="variable">$&#123;target&#125;</span></span><br><span class="line">    PRIVATE</span><br><span class="line">      $&lt;$&lt;CXX_COMPILER_ID:MSVC&gt;:/W4 /permissive-&gt;</span><br><span class="line">      $&lt;$&lt;<span class="keyword">NOT</span>:$CXX_COMPILER_ID:MSVC&gt;&gt;:-Wall -Wextra -Wpedantic&gt;)</span><br><span class="line"><span class="keyword">endfunction</span>()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🧱-src-myproject-cpp"><a href="#🧱-src-myproject-cpp" class="headerlink" title="🧱 src&#x2F;myproject.cpp"></a>🧱 src&#x2F;myproject.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myproject/myproject.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">myproject::say_hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello, CMake world!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📘-include-myproject-myproject-h"><a href="#📘-include-myproject-myproject-h" class="headerlink" title="📘 include&#x2F;myproject&#x2F;myproject.h"></a>📘 include&#x2F;myproject&#x2F;myproject.h</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="keyword">namespace</span> myproject &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">say_hello</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🧪-tests-CMakeLists-txt"><a href="#🧪-tests-CMakeLists-txt" class="headerlink" title="🧪 tests&#x2F;CMakeLists.txt"></a>🧪 tests&#x2F;CMakeLists.txt</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span>(test_main test_main.cpp)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(test_main PRIVATE myproject)</span><br><span class="line"><span class="keyword">add_test</span>(NAME test_main <span class="keyword">COMMAND</span> test_main)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🧪-tests-test-main-cpp"><a href="#🧪-tests-test-main-cpp" class="headerlink" title="🧪 tests&#x2F;test_main.cpp"></a>🧪 tests&#x2F;test_main.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myproject/myproject.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    myproject::<span class="built_in">say_hello</span>();</span><br><span class="line">    <span class="comment">// 简单验证输出，可扩展为单元测试框架（如 Catch2 或 GoogleTest）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="📥-构建与测试指令"><a href="#📥-构建与测试指令" class="headerlink" title="📥 构建与测试指令"></a>📥 构建与测试指令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1️⃣ 配置构建</span></span><br><span class="line">cmake -S . -B build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2️⃣ 编译</span></span><br><span class="line">cmake --build build -j</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3️⃣ 运行测试</span></span><br><span class="line">ctest --test-dir build --output-on-failure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4️⃣ 安装到本地（默认 /usr/local）</span></span><br><span class="line">cmake --install build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5️⃣ 打包</span></span><br><span class="line">cpack --config build/CPackConfig.cmake</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<p>✅ 这一套模板能立即运行：<br>在一个空目录中复制这些文件 → 构建 → 运行 → 看到<br><code>Hello, CMake world!</code> 输出，即成功！</p>
<hr>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    
    <a class="pull-right" href="/%E7%AE%80%E6%98%8ECMAKE%E8%AF%AD%E6%B3%95%E4%B8%8E%E5%B7%A5%E7%A8%8B%E7%AE%A1%E7%90%86%E6%8C%87%E5%8D%97/">
        简明CMAKE语法与工程管理指南 →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By Fravel Wang. All Rights Reserved.
                </p>
                <p>Theme By <a target="_blank" rel="noopener" href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
